<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’»çŸ³äº¤æ˜“ - GameTrade</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app" class="container">

        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="header">
            <div class="header-content">
                <a href="index.html" class="back-btn">â†</a>
                <div class="header-title">é’»çŸ³äº¤æ˜“å¸‚åœº</div>
                <!-- toggleTheme åœ¨ common.js é‡Œ -->
                <button class="theme-toggle-btn" onclick="toggleTheme()">ğŸŒ“</button>
            </div>
        </header>

        <main class="main-content">
            <!-- æ–°å¢æœ€è¿‘ä¸‰å¤©å¹³å‡å•ä»·å±•ç¤ºåŒºåŸŸ -->
            <div class="price-stats-card">
                <div class="price-stats-header">
                    <span class="price-stats-title">è¿‘3æ—¥æˆäº¤å‡ä»·</span>
                    <span class="price-stats-badge">å®æ—¶æ•°æ®</span>
                </div>
                <div class="price-stats-body">
                    <div class="price-stat-item">
                        <div class="price-stat-value">Â¥{{unit_price}}</div>
                        <div class="price-stat-label">å¹³å‡å•ä»·/é’»</div>
                    </div>
                    <div class="price-stat-divider"></div>
                    <div class="price-stat-item">
                        <div class="price-stat-value">{{diamond_amount}}</div>
                        <div class="price-stat-label">æˆäº¤é’»çŸ³æ•°</div>
                    </div>
                    <div class="price-stat-divider"></div>
                    <div class="price-stat-item">
                        <div class="price-stat-value">{{total_count}}</div>
                        <div class="price-stat-label">æˆäº¤ç¬”æ•°</div>
                    </div>
                </div>
            </div>
            <!-- æ‰¹é‡è´­ä¹°åŒºåŸŸ -->
            <!--<div class="bulk-purchase-mobile">
        <input type="number"
               class="input-field"
               placeholder="è¾“å…¥éœ€è¦è´­ä¹°çš„é’»çŸ³æ•°é‡"
               min="1"
               v-model="bulkAmount"
               oninput="this.value=this.value.replace(/[^0-9]/g,'')">
        <button class="btn-primary" v-on:click="openBulk">
            æ‰¹é‡è´­ä¹°
        </button>
    </div>-->
            <!-- åœ¨å”®å•†å“åˆ—è¡¨ -->
            <div class="search-box">
                <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8" />
                    <path d="M21 21l-4.35-4.35" />
                </svg>
                <input type="text" class="search-input" placeholder="è¾“å…¥ç§ä¸‹äº¤æ˜“ç æœç´¢" v-model="tradeCode" onchange="search()">
            </div>
            <div class="products-list">

                <!-- æ— æ•°æ®æ—¶ -->
                <div class="no-data" v-if="items.length === 0">
                    æš‚æ— åœ¨å”®å•†å“
                </div>

                <!-- æœ‰æ•°æ®æ—¶ -->
                <div class="product-card" v-for="item in items">
                    <div class="product-header">
                        <span class="seller-name">
                            {{ item.nickname  }}
                        </span>
                        <span class="product-badge">åœ¨å”®</span>
                    </div>
                    <div class="product-body">
                        <div class="product-info">
                            <div class="product-amount">{{ item.diamond_amount }} ğŸ’</div>
                            <div class="product-unit">å•ä»·: Â¥{{ item.unit_price }}/é’»</div>
                        </div>
                        <div class="product-right">
                            <div class="product-price">Â¥ {{ item.total_price }}</div>
                            <button class="btn-buy"
                                    v-on:click="openSingle(item)">
                                è´­ä¹°
                            </button>
                        </div>
                    </div>
                </div>

            </div>

            <!-- è´­ä¹°å¼¹çª—ï¼ˆå•ä¹° / æ‰¹é‡å…±ç”¨ï¼‰ -->
            <div class="modal" v-if="showModal" style="display:none">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 v-if="modal.isBulk">æ‰¹é‡è´­ä¹°è®¢å•</h2>
                        <h2 v-if="!modal.isBulk">è´­ä¹°é’»çŸ³</h2>
                        <span class="modal-close" v-on:click="closeModal">&times;</span>
                    </div>

                    <div class="modal-body">
                        <div class="order-summary">
                            <div class="summary-row">
                                <span>è´­ä¹°æ•°é‡:</span>
                                <span class="summary-value">{{ modal.amount }} ğŸ’</span>
                            </div>
                            <div class="summary-row">
                                <span>åˆè®¡é‡‘é¢:</span>
                                <!-- å•ä¹°æ˜¾ç¤ºæ€»ä»·ï¼Œæ‰¹é‡å¯æ˜¾ç¤ºé¢„ä¼°æˆ– 0 -->
                                <span class="summary-value">
                                    Â¥ {{ modal.total}}
                                </span>
                            </div>
                            <div class="summary-items">
                                <div class="summary-note" v-if="modal.isBulk">
                                    ç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨é€‰æ‹©æœ€ä¼˜æƒ çš„å•†å“ç»„åˆï¼Œå®é™…æ‰£æ¬¾é‡‘é¢ä»¥æˆäº¤ä¸ºå‡†
                                </div>
                                <div class="summary-note" v-else>
                                    å–å®¶: {{ modal.seller }}
                                </div>
                            </div>
                        </div>

                        <!--<div class="form-group">
                    <label class="form-label">æ¸¸æˆç±»å‹</label>
                    <select class="form-input" v-model="modal.gameType" required>
                        <option value="">è¯·é€‰æ‹©æ¸¸æˆç±»å‹</option>
                        <option value="AGPoker">AGPoker</option>
                    </select>
                </div>-->

                        <div class="form-group">
                            <label class="form-label">æ¸¸æˆè´¦å·</label>
                            <input type="text"
                                   class="form-input"
                                   v-model="modal.gameAccount"
                                   placeholder="è¯·è¾“å…¥æ¸¸æˆè´¦å·"
                                   required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">æ¸¸æˆå¯†ç </label>
                            <input type="password"
                                   class="form-input"
                                   v-model="modal.gamePassword"
                                   placeholder="è¯·è¾“å…¥æ¸¸æˆå¯†ç "
                                   required>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button class="btn-secondary" v-on:click="closeModal">å–æ¶ˆ</button>
                        <button class="btn-primary" v-on:click="confirmPurchase">
                            ç¡®è®¤è´­ä¹°
                        </button>
                    </div>
                </div>
            </div>

        </main>

        <!-- åº•éƒ¨å¯¼èˆªæ  -->
        <nav class="bottom-nav">
            <a href="index.html" class="nav-item">
                <span class="nav-icon">ğŸ </span>
                <span class="nav-label">é¦–é¡µ</span>
            </a>
            <a href="publish.html" class="nav-item">
                <span class="nav-icon">â•</span>
                <span class="nav-label">å‘å¸ƒ</span>
            </a>
            <a href="profile.html" class="nav-item">
                <span class="nav-icon">ğŸ‘¤</span>
                <span class="nav-label">æˆ‘çš„</span>
            </a>
        </nav>

    </div>

    <!-- å…¬å…±è„šæœ¬ï¼štinyVue + api/ä¸»é¢˜ -->
    <script src="js/tinyVue.js"></script>
    <script src="js/common.js"></script>

    <script>
        // vm å®ä¾‹
        const vm = tinyVue({
            el: "#app",
            data: {
                // åˆ—è¡¨æ•°æ®
                items: [],

                // æ‰¹é‡è´­ä¹°è¾“å…¥
                bulkAmount: "",
                tradeCode:'',
                // å¼¹çª—çŠ¶æ€
                showModal: false,
                modal: {
                    isBulk: false,
                    itemId: null,
                    seller: "",
                    amount: 0,
                    total: 0,
                    gameType: "",
                    gameAccount: "",
                    gamePassword: ""
                },
                total_count: 0,
                unit_price: 0,
                diamond_amount: 0,
            },
            methods: {
                // åŠ è½½åœ¨å”®å•†å“åˆ—è¡¨
                async loadData() {
                    const res = await api("/api/diamond/salelist", "POST", {
                        tradeCode: this.tradeCode
                    });
                    if (!res) return;
                    // åç«¯è¿”å› { code:0, data:[...] }
                    this.items = res.data || [];

                    // å¦‚æœ tinyVue æœ‰ $forceUpdateï¼Œå°±è°ƒç”¨ç¡®ä¿åˆ·æ–°
                    if (this.$forceUpdate) this.$forceUpdate();
                },
                async loadData2() {
                    const res = await api("/api/diamond/salelistRecent", "POST");
                    if (!res) return;
                    // åç«¯è¿”å› { code:0, data:[...] }
                    this.total_count = res.total_count || 0;
                    this.unit_price = res.unit_price || 0;
                    this.diamond_amount = res.diamond_amount || 0;

                    // å¦‚æœ tinyVue æœ‰ $forceUpdateï¼Œå°±è°ƒç”¨ç¡®ä¿åˆ·æ–°
                    if (this.$forceUpdate) this.$forceUpdate();
                },


                // æ‰“å¼€æ‰¹é‡è´­ä¹°å¼¹çª—
                openBulk() {
                    const num = parseInt(this.bulkAmount);
                    if (!num || num <= 0) {
                        alert("è¯·è¾“å…¥æœ‰æ•ˆçš„é’»çŸ³æ•°é‡");
                        return;
                    }

                    this.modal.isBulk = true;
                    this.modal.itemId = null;
                    this.modal.seller = "";
                    this.modal.amount = num;
                    // å‰ç«¯ä¸é¢„ä¼°ä»·æ ¼ï¼Œäº¤ç»™åç«¯ç®—ï¼›è¿™é‡Œå±•ç¤º 0 æˆ–è€…ä½ æƒ³è¦çš„é¢„ä¼°
                    this.modal.total = 0;
                    this.modal.gameType = "AGPoker";
                    this.modal.gameAccount = "";
                    this.modal.gamePassword = "";

                    this.showModal = true;

                    this.$forceUpdate();
                },

                // å…³é—­å¼¹çª—
                closeModal() {
                    this.showModal = false;
                    if (this.$forceUpdate) this.$forceUpdate();
                },

                // ç¡®è®¤è´­ä¹°ï¼ˆå•ä¹°/æ‰¹é‡ï¼‰
                async confirmPurchase() {
                    if (!this.modal.gameType ||
                        !this.modal.gameAccount ||
                        !this.modal.gamePassword) {
                        alert("è¯·å¡«å†™å®Œæ•´çš„æ¸¸æˆä¿¡æ¯");
                        return;
                    }

                    let url;
                    let payload;

                    if (this.modal.isBulk) {
                        // æ‰¹é‡è´­ä¹°æ¥å£ï¼ˆä½ æŒ‰åç«¯å®é™…æ”¹ï¼‰
                        url = "/api/order/bulk-buy";
                        payload = {
                            diamond_amount: this.modal.amount,
                            game_type: this.modal.gameType,
                            game_user: this.modal.gameAccount,
                            game_pass: this.modal.gamePassword
                        };
                    } else {
                        // å•ä¸ªè´­ä¹°æ¥å£ï¼ˆä½ æŒ‰åç«¯å®é™…æ”¹ï¼‰
                        url = "/api/order/buy";
                        payload = {
                            item_id: this.modal.itemId,
                            game_type: this.modal.gameType,
                            game_user: this.modal.gameAccount,
                            diamond_amount: this.modal.amount,
                            game_pass: this.modal.gamePassword
                        };
                    }

                    const res = await api(url, "POST", payload);
                    if (!res) return;

                    alert("è´­ä¹°æˆåŠŸï¼");
                    this.showModal = false;
                    this.bulkAmount = "";
                    // é‡æ–°åŠ è½½åˆ—è¡¨
                    await this.loadData();
                }
            }
        });

        // é¦–æ¬¡è¿›å…¥é¡µé¢åŠ è½½åˆ—è¡¨
        vm.loadData();
        vm.loadData2();
        function search() {
            vm.loadData();
        }
        // æ‰“å¼€å•ä¸ªè´­ä¹°å¼¹çª—
        function openSingle(item) {
            vm.modal.isBulk = false;
            vm.modal.itemId = item.id;
            vm.modal.seller = item.nickname;
            vm.modal.amount = item.diamond_amount;
            vm.modal.total = item.total_price;
            vm.modal.gameType = "AGPoker";
            vm.modal.gameAccount = "";
            vm.modal.gamePassword = "";

            vm.showModal = true;
            vm.$forceUpdate();
        }
    </script>

    <script>
        (function () {
            // åŸ‹ç‚¹æ¥å£
            const url = "/api/stat/page-view";
            const token = localStorage.getItem("token");
            // é¡µé¢æ•°æ®
            const data = {
                page: "é’»çŸ³äº¤æ˜“é¡µé¢",
                referrer: document.referrer,
                ua: navigator.userAgent,
                ts: Date.now()
            };

            fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    ...(token ? { "Authorization": "Bearer " + token } : {})
                },
                body: data ? JSON.stringify(data) : null
            });
        })();
    </script>
</body>
</html>
