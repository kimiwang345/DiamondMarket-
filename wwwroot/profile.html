<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ - GameTrade</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/chat-styles.css">
</head>

<body>
    <div id="app">

        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">ğŸ’</span>
                    <span class="logo-text">GameTrade</span>
                </div>
                <button class="theme-toggle-btn" onclick="toggleTheme()">ğŸŒ“</button>
            </div>
        </header>

        <main class="main-content">

            <!-- ç”¨æˆ·ä¿¡æ¯ -->
            <div class="profile-header">
                <div class="user-info">
                    <div class="user-avatar">ğŸ‘¤</div>
                    <div class="user-details">
                        <h2 class="user-name">{{ nickname }}</h2>
                        <p class="user-id">{{ login_name }}</p>

                    </div>
                    <button class="btn-action-login" v-on:click="loginout">é€€å‡ºç™»å½•</button>
                </div>
            </div>

            <!-- ä½™é¢ -->
            <div class="balance-section">
                <div class="balance-card">
                    <div class="balance-label">è´¦æˆ·ä½™é¢</div>
                    <div class="balance-amount">Â¥ {{ amount }}</div>
                    <div class="balance-actions">
                        <button class="btn-action" v-on:click="openRecharge" v-if="user_type==0">å……å€¼</button>
                        <button class="btn-action" v-on:click="openRecharge" v-if="user_type==2">å……å€¼</button>
                        <button class="btn-action" v-on:click="openAdminRecharge" v-if="user_type==1" style="display:none">å……å€¼å¤„ç†</button>
                        <button class="btn-action" v-on:click="openWithdraw" v-if="user_type==0">æç°</button>
                        <button class="btn-action" v-on:click="openAdminWithdraw" v-if="user_type==1" style="display:none">æç°å¤„ç†</button>
                    </div>
                    <div class="balance-record">
                        <a href="records.html">æŸ¥çœ‹å……æè®°å½•</a>
                    </div>
                </div>
            </div>
            <!-- æ·»åŠ åœ¨çº¿å®¢æœæŒ‰é’® -->
            <div class="service-section">
                <button class="service-btn service-btn-relative" v-on:click="openCustomerService">

                    <span class="service-icon">ğŸ’¬</span>
                    <!-- ğŸ”¥ æœªè¯»å°çº¢ç‚¹ -->
                    <div class="service-badge" v-if="unreadChatCount > 0">
                        {{ unreadChatCount }}
                    </div>
                    <div class="service-content">
                        <div class="service-title">
                            åœ¨çº¿å®¢æœ
                        </div>
                        <div class="service-desc">æœ‰é—®é¢˜ï¼Ÿè”ç³»å®¢æœè·å–å¸®åŠ©</div>
                    </div>
                    <span class="service-arrow">â†’</span>
                </button>
            </div>
            <!-- æ·»åŠ è®¿é—®æŠ¥è¡¨æŒ‰é’® -->
            <div class="service-section" v-if="user_type==1">
                <button class="service-btn service-btn-relative" v-on:click="openAdminReport">

                    <span class="service-icon">ğŸ’</span>
                    <div class="service-content">
                        <div class="service-title">
                            è®¿é—®æŠ¥è¡¨
                        </div>
                        <div class="service-desc">è®¿é—®æŠ¥è¡¨ï¼ŒPV/UV</div>
                    </div>
                    <span class="service-arrow">â†’</span>
                </button>
            </div>
            <!-- æ·»åŠ ç»Ÿè®¡æŠ¥è¡¨æŒ‰é’® -->
            <div class="service-section" v-if="user_type==1">
                <button class="service-btn service-btn-relative" v-on:click="openAdminTradeReport">

                    <span class="service-icon">ğŸ’°</span>
                    <div class="service-content">
                        <div class="service-title">
                            ç»Ÿè®¡æŠ¥è¡¨
                        </div>
                        <div class="service-desc">ç»Ÿè®¡æŠ¥è¡¨,é’»çŸ³äº¤æ˜“ã€å……æç°ç»Ÿè®¡</div>
                    </div>
                    <span class="service-arrow">â†’</span>
                </button>
            </div>
            <!-- Tabs -->
            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab-btn"
                            :class="{active: tab==='selling'}"
                            v-on:click="switchTab('selling')">
                        åœ¨å”®å•†å“
                    </button>

                    <button class="tab-btn"
                            :class="{active: tab==='purchased'}"
                            v-on:click="switchTab('purchased')">
                        è´­ä¹°è®°å½•
                    </button>

                    <button class="tab-btn"
                            :class="{active: tab==='sold'}"
                            v-on:click="switchTab('sold')">
                        å‡ºå”®è®°å½•
                    </button>

                    <button class="tab-btn"
                            :class="{active: tab==='amount'}"
                            v-on:click="switchTab('amount')">
                        ä½™é¢è®°å½•
                    </button>
                </div>

                <!-- ===== åœ¨å”®å•†å“ ===== -->
                <div class="tab-content" v-if="tab==='selling'">
                    <div class="record-list">
                        <div class="no-data" v-if="selling.length === 0">
                            æš‚æ— åœ¨å”®å•†å“
                        </div>
                        <div class="record-item" v-for="item in selling" v-for-template>
                            <div class="record-info">
                                <div class="record-title">{{ item.diamond_amount }} ğŸ’</div>
                                <div class="record-title" v-if="item.trade_code!=''">äº¤æ˜“ç ï¼š{{ item.trade_code }} </div>
                                <div class="record-meta">å•ä»·: Â¥{{ item.unit_price }}/é’»</div>
                                <div class="record-time">å‘å¸ƒäº {{ item.create_time }}</div>
                            </div>

                            <div class="record-right">
                                <div class="record-amount">Â¥ {{ item.total_price }}</div>
                                <button class="btn-small btn-danger"
                                        v-on:click="offSale(item.id)">
                                    ä¸‹æ¶
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== è´­ä¹°è®°å½• ===== -->
                <div class="tab-content" v-if="tab==='purchased'">
                    <div class="record-list">
                        <div class="no-data" v-if="purchased.length === 0">
                            æš‚æ— è´­ä¹°è®°å½•
                        </div>
                        <div class="record-item" v-for="order in purchased">
                            <div class="record-info">
                                <div class="record-title">{{ order.diamond_amount }} ğŸ’</div>
                                <div class="record-meta">{{ order.order_no }}</div>
                                <div class="record-meta">å–å®¶: {{ order.seller_name }}</div>
                                <div class="record-time">{{ order.create_time }}</div>
                            </div>

                            <div class="record-right">
                                <div class="record-amount"> Â¥ -{{ order.total_price }}</div>
                                <div class="record-status status-completed">å·²å®Œæˆ</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== å‡ºå”®è®°å½• ===== -->
                <div class="tab-content" v-if="tab==='sold'">
                    <div class="record-list">
                        <div class="no-data" v-if="sold.length === 0">
                            æš‚æ— å‡ºå”®è®°å½•
                        </div>
                        <div class="record-item" v-for="order in sold">
                            <div class="record-info">
                                <div class="record-title">{{ order.diamond_amount }} ğŸ’</div>
                                <div class="record-meta">{{ order.order_no }}</div>
                                <div class="record-meta">ä¹°å®¶: {{ order.buyer_name }}</div>
                                <div class="record-time">{{ order.create_time }}</div>
                            </div>

                            <div class="record-right">
                                <div class="record-amount"> Â¥ +{{ order.total_price }}</div>
                                <div class="record-status status-completed">å·²å®Œæˆ</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== ä½™é¢è®°å½• ===== -->
                <div class="tab-content" v-if="tab==='amount'">
                    <div class="record-list">
                        <div class="no-data" v-if="balanceLogs.length === 0">
                            æš‚æ— è®°å½•
                        </div>
                        <div class="record-item" v-for="order in balanceLogs">
                            <div class="record-info">
                                <div class="record-title">{{ order.before_amount }} å˜ {{ order.after_amount }}</div>
                                <div class="record-meta">{{ order.remark }}</div>
                                <div class="record-time">{{ order.create_time }}</div>
                            </div>

                            <div class="record-right">
                                <div class="record-amount"> Â¥ {{ order.amount }}</div>
                                <div class="record-status status-completed">å·²å®Œæˆ</div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </main>
        <div v-if="withdrawModal" class="modal" style="display:none">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>æç°</h2>
                    <span class="modal-close" v-on:click="withdrawModal=false">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="balance-info">
                        <span>å¯æç°ä½™é¢:</span>
                        <span class="balance-value">Â¥ {{ amount }}</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æç°é‡‘é¢</label>
                        <input type="number" class="form-input" v-model="withdrawForm.amount" placeholder="è¯·è¾“å…¥æç°é‡‘é¢" min="1" max="{{amount}}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æç°æ–¹å¼</label>
                        <select class="form-input" v-model="withdrawForm.pay_channel">
                            <option value="ZFB">æ”¯ä»˜å®</option>
                            <option value="WX">å¾®ä¿¡</option>
                            <!--<option value="CARD">é“¶è¡Œå¡</option>-->
                            <option value="USDT">USDT</option>
                        </select>
                    </div>
                    <div class="form-section">
                        <label class="form-label">æ”¶æ¬¾äºº</label>
                        <div class="form-group">
                            <input type="text" class="form-input" id="paymentInfo" v-model="withdrawForm.name" placeholder="è¯·è¾“å…¥æ”¶æ¬¾ä¿¡æ¯">
                        </div>
                    </div>
                    <!-- æ”¶æ¬¾äºŒç»´ç ä¸Šä¼ åŒºåŸŸ -->
                    <div class="form-group" id="qrcodeUploadSection" v-if="withdrawForm.pay_channel=='WX'||withdrawForm.pay_channel=='ZFB'">
                        <label class="form-label">ä¸Šä¼ æ”¶æ¬¾ç </label>
                        <div class="qr-upload" id="uploadArea" onclick="document.getElementById('qrcodeFile').click()">
                            <input type="file" id="qrcodeFile" accept="image/*" style="display: none; " v-model="withdrawForm.pay_url">
                            <div class="upload-placeholder" id="uploadPlaceholder">
                                <span class="upload-icon">ğŸ“·</span>
                                <span class="upload-hint">ä¸Šä¼ æ”¶æ¬¾ç ,æ”¯æŒ JPGã€PNG æ ¼å¼</span>
                            </div>
                            <img id="qrcodePreview" class="qrcode-preview" style="display: none;">
                        </div>
                    </div>

                    <!-- æ”¶æ¬¾ä¿¡æ¯å¡«å†™åŒºåŸŸ -->
                    <div class="form-section" v-if="withdrawForm.pay_channel=='CARD'||withdrawForm.pay_channel=='USDT'">
                        <label class="form-label" v-if="withdrawForm.pay_channel=='CARD'">é“¶è¡Œå¡å·</label>
                        <label class="form-label" v-if="withdrawForm.pay_channel=='USDT'">USDTåœ°å€</label>
                        <div class="form-group">
                            <input type="text" class="form-input" v-model="withdrawForm.pay_info" placeholder="è¯·è¾“å…¥æ”¶æ¬¾ä¿¡æ¯">
                        </div>
                    </div>
                    <div class="withdraw-note">
                        æç°å°†åœ¨1-3ä¸ªå·¥ä½œæ—¥å†…åˆ°è´¦
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" v-on:click="withdrawModal=false">å–æ¶ˆ</button>
                    <button class="btn-primary" v-on:click="confirmWithdraw">ç¡®è®¤æç°</button>
                </div>
            </div>
        </div>


        <!-- æ·»åŠ å®¢æœå¼¹çª— -->
        <div id="customerServiceModal" class="chat-modal" v-if="customerServiceShow">
            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-header-info">
                        <div class="chat-avatar online">
                            <span>å®¢</span>
                            <span class="online-dot"></span>
                        </div>
                        <div class="chat-header-text">
                            <h3>åœ¨çº¿å®¢æœ</h3>
                            <span class="chat-status">åœ¨çº¿</span>
                        </div>
                    </div>
                    <button class="chat-close-btn" v-on:click="closeChat">âœ•</button>
                </div>

                <div class="chat-messages" id="chatMessages">
                </div>

                <!-- å¿«æ·é—®é¢˜ -->
                <div class="quick-replies">
                    <button class="quick-reply-btn" onclick="sendQuickReply('å¦‚ä½•å‘å¸ƒå•†å“ï¼Ÿ')">å¦‚ä½•å‘å¸ƒå•†å“ï¼Ÿ</button>
                    <button class="quick-reply-btn" v-on:click="sendQuickReply('å¦‚ä½•å……å€¼ï¼Ÿ')">å¦‚ä½•å……å€¼ï¼Ÿ</button>
                    <button class="quick-reply-btn" v-on:click="sendQuickReply('äº¤æ˜“å®‰å…¨å—ï¼Ÿ')">äº¤æ˜“å®‰å…¨å—ï¼Ÿ</button>
                </div>

                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="chat-input-area">
                    <div class="chat-input-wrapper">
                        <button class="chat-attachment-btn" v-on:click="selectImage()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                        </button>

                        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">

                        <input type="text" class="chat-input" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="handleKeyPress(event)">

                        <button class="chat-send-btn" v-on:click="sendMessage()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ å›¾ç‰‡é¢„è§ˆå¼¹çª— -->
        <div id="imagePreviewModal" class="image-preview-modal" onclick="closeImagePreview()">
            <div class="image-preview-container">
                <img id="previewImage" src="/placeholder.svg" alt="é¢„è§ˆå›¾ç‰‡">
                <button class="image-preview-close">âœ•</button>
            </div>
        </div>
        <!-- åº•éƒ¨å¯¼èˆª -->
        <nav class="bottom-nav">
            <a href="index.html" class="nav-item">
                <span class="nav-icon">ğŸ </span>
                <span class="nav-label">é¦–é¡µ</span>
            </a>
            <a href="publish.html" class="nav-item">
                <span class="nav-icon">â•</span>
                <span class="nav-label">å‘å¸ƒ</span>
            </a>
            <a href="profile.html" class="nav-item active">
                <span class="nav-icon">ğŸ‘¤</span>
                <span class="nav-label">æˆ‘çš„</span>
            </a>
        </nav>

    </div>
    <script src="js/tinyVue.js"></script>
    <script src="js/common.js"></script>


    <script>
        const vm = tinyVue({
            el: "#app",
            data: {
                unreadChatCount: 0,
                withdrawModal: false,
                customerServiceShow: false,
                nickname: "",
                login_name: "",
                user_type: 0,
                user_id: 0,
                amount: 0,
                tab: "selling",
                selling: [],
                purchased: [],
                sold: [],
                balanceLogs: [],

                withdrawForm: {
                    amount: 0,
                    pay_channel: '',
                    pay_url: '',
                    pay_info: '',
                    name: '',
                },

                // ===== åˆ†é¡µ =====
                pageIndex: 1,
                pageSize: 10,
                total: 0,
                totalPages: 1,

                // ===== è‡ªåŠ¨åŠ è½½æ§åˆ¶ =====
                isLoading: false,
                finished: false
            }
        });

        // åŠ è½½æ•°æ®
        async function loadUserData() {
            const user = await api("/api/user/queryUser");

            vm.nickname = user.data.nickname;
            vm.login_name = user.data.login_name;
            vm.user_type = user.data.user_type;
            vm.user_id = user.data.id;
            vm.amount = user.data.amount;
            loadData(false);
            vm.$forceUpdate();
        }
        async function loadData(append = false) {
            var t = vm.tab;
            if (t == 'selling') {
                if (vm.isLoading) return;
                vm.isLoading = true;
                try {
                    const p = await api("/api/diamond/my-selling", "POST", {
                        pageIndex: vm.pageIndex,
                        pageSize: vm.pageSize
                    });

                    if (p) {
                        if (append) {
                            // è¿½åŠ åˆ°åˆ—è¡¨æœ«å°¾
                            vm.selling = vm.selling.concat(p.data || []);
                        } else {
                            // é¦–æ¬¡åŠ è½½ / åˆ‡æ¢çŠ¶æ€
                            vm.selling = p.data || [];
                        }

                        vm.total = p.total || 0;
                        vm.totalPages = Math.max(1, Math.ceil(vm.total / vm.pageSize));

                        // å¦‚æœå·²ç»åˆ°æœ€åä¸€é¡µ
                        vm.finished = vm.pageIndex >= vm.totalPages;
                    }

                    vm.isLoading = false;
                    vm.$forceUpdate();
                } finally {
                    vm.isLoading = false;
                }
            }
            if (t == 'purchased') {
                if (vm.isLoading) return;
                vm.isLoading = true;
                try {
                    const p = await api("/api/order/my-purchased", "POST", {
                        pageIndex: vm.pageIndex,
                        pageSize: vm.pageSize
                    });

                    if (p) {
                        if (append) {
                            // è¿½åŠ åˆ°åˆ—è¡¨æœ«å°¾
                            vm.purchased = vm.purchased.concat(p.data || []);
                        } else {
                            // é¦–æ¬¡åŠ è½½ / åˆ‡æ¢çŠ¶æ€
                            vm.purchased = p.data || [];
                        }

                        vm.total = p.total || 0;
                        vm.totalPages = Math.max(1, Math.ceil(vm.total / vm.pageSize));

                        // å¦‚æœå·²ç»åˆ°æœ€åä¸€é¡µ
                        vm.finished = vm.pageIndex >= vm.totalPages;
                    }

                    vm.isLoading = false;
                    vm.$forceUpdate();
                } finally {
                    vm.isLoading = false;
                }
            }
            if (t == 'sold') {
                if (vm.isLoading) return;
                vm.isLoading = true;
                try {
                    const p = await api("/api/order/my-sold", "POST", {
                        pageIndex: vm.pageIndex,
                        pageSize: vm.pageSize
                    });

                    if (p) {
                        if (append) {
                            // è¿½åŠ åˆ°åˆ—è¡¨æœ«å°¾
                            vm.sold = vm.sold.concat(p.data || []);
                        } else {
                            // é¦–æ¬¡åŠ è½½ / åˆ‡æ¢çŠ¶æ€
                            vm.sold = p.data || [];
                        }

                        vm.total = p.total || 0;
                        vm.totalPages = Math.max(1, Math.ceil(vm.total / vm.pageSize));

                        // å¦‚æœå·²ç»åˆ°æœ€åä¸€é¡µ
                        vm.finished = vm.pageIndex >= vm.totalPages;
                    }

                    vm.isLoading = false;
                    vm.$forceUpdate();
                } finally {
                    vm.isLoading = false;
                }
            }
            if (t == 'amount') {
                if (vm.isLoading) return;
                vm.isLoading = true;
                try {
                    const p = await api("/api/user/balance-log", "POST", {
                        pageIndex: vm.pageIndex,
                        pageSize: vm.pageSize
                    });

                    if (p) {
                        if (append) {
                            // è¿½åŠ åˆ°åˆ—è¡¨æœ«å°¾
                            vm.balanceLogs = vm.balanceLogs.concat(p.data || []);
                        } else {
                            // é¦–æ¬¡åŠ è½½ / åˆ‡æ¢çŠ¶æ€
                            vm.balanceLogs = p.data || [];
                        }

                        vm.total = p.total || 0;
                        vm.totalPages = Math.max(1, Math.ceil(vm.total / vm.pageSize));

                        // å¦‚æœå·²ç»åˆ°æœ€åä¸€é¡µ
                        vm.finished = vm.pageIndex >= vm.totalPages;
                    }

                    vm.isLoading = false;
                    vm.$forceUpdate();
                } finally {
                    vm.isLoading = false;
                }
            }
            vm.$forceUpdate();
        }

        async function switchTab(t) {
            vm.tab = t;
            vm.pageIndex = 1;
            vm.finished = false;
            vm.$forceUpdate();
            loadData(false);
            vm.$forceUpdate();
        };

        vm.offSale = async function offSale(id) {
            if (!confirm("ç¡®è®¤ä¸‹æ¶ï¼Ÿ")) return;
            await api(`/api/diamond/off-sale/${id}`, "POST");
            loadData(false);
        };


        vm.openWithdraw = function () {

            vm.withdrawForm = {
                amount: 0,
                pay_channel: '',
                pay_url: '',
                pay_info: '',
                name: '',
            };
            vm.withdrawModal = true;
        };
        vm.openCustomerService = async function () {
            if (vm.user_type == 1) {
                //å®¢æœ
                window.location.href = "admin-chat.html"
                return;
            }
            else {
                vm.customerServiceShow = true;
                vm.unreadChatCount = 0;
                isChatOpen = true;

                await api("/api/chat/read-all", "POST", {});   // æ ‡è®°å·²è¯»

                document.getElementById("chatMessages").innerHTML = "";

                chatMaxId = Number.MAX_SAFE_INTEGER;
                latestId = 0;

                await loadHistoryFrist();

                startPolling();
            }

        }
        vm.openAdminReport = function () {
            window.location.href = "admin-stats.html"
        }
        vm.openAdminTradeReport = function () {
            window.location.href = "admin-trade-stats.html"
        }
        vm.closeChat = function () {
            vm.customerServiceShow = false;
            isChatOpen = false;
            clearInterval(timer);
        }

        vm.openAdminWithdraw = function () {
            window.location.href = "admin-withdraw.html"
        }

        vm.loginout = function () {
            localStorage.setItem("token", "");
            window.location.href = "login.html"
        }
        vm.openAdminRecharge = function () {
            window.location.href = "admin-recharge.html"
        }
        vm.openRecharge = function () {
            window.location.href = "recharge.html"
        }
        vm.confirmWithdraw = async function () {
            if (!vm.withdrawForm.amount || vm.withdrawForm.amount <= 0) {
                alert("è¯·è¾“å…¥æç°é‡‘é¢");
                return;
            }

            if (!vm.withdrawForm.pay_channel) {
                alert("è¯·é€‰æ‹©æç°æ–¹å¼");
                return;
            }

            if (!vm.withdrawForm.name) {
                alert("è¯·è¾“å…¥æ”¶æ¬¾äººå§“å");
                return;
            }

            if (!vm.withdrawForm.pay_url && (vm.withdrawForm.pay_channel === "WX" || vm.withdrawForm.pay_channel === "ZFB")) {
                alert("è¯·ä¸Šä¼ æ”¶æ¬¾äºŒç»´ç ");
                return;
            }

            if (!vm.withdrawForm.pay_info && (vm.withdrawForm.pay_channel === "CARD")) {
                alert("è¯·è¾“å…¥å¡å·");
                return;
            }

            if (!vm.withdrawForm.pay_info && (vm.withdrawForm.pay_channel === "USDT")) {
                alert("è¯·è¾“å…¥USDTåœ°å€");
                return;
            }

            const res = await api("/api/finance/withdraw", "POST", vm.withdrawForm);

            if (!res) return;
            vm.withdrawModal = false;
            loadData(false);
            alert("æç°ç”³è¯·å·²æäº¤,é¢„è®¡1-3ä¸ªå·¥ä½œæ—¥åˆ°è´¦ï¼");
        };


        loadUserData();

        let sendMsgRuning = false;
        async function sendMessage() {
            if (sendMsgRuning) {
                return;
            }
            sendMsgRuning = true;
            try {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                if (!message) return;

                //appendMessage(message, 'sent');

                await api("/api/chat/send", "POST", {
                    to_id: 0,          // åç«¯å®¢æœ ID
                    msg_type: 1,
                    content: message
                });
                latestMsg();
                input.value = '';
            } catch (e) {
                sendMsgRuning = false;
            } finally {

                sendMsgRuning = false;
            }
        }

        function appendMessage(content, type, isImage = false) {
            const chatMessages = document.getElementById('chatMessages');
            const wrapper = document.createElement('div');
            wrapper.className = 'message-wrapper ' + type;

            let html = '';
            if (type === 'received') {
                html += '<div class="message-avatar">å®¢</div>';
            }
            html += '<div class="message-content">';
            if (isImage) {
                html += '<div class="message-bubble image-message"><img src="' + content + '" alt="å›¾ç‰‡" onclick="previewImage(this.src)"></div>';
            } else {
                html += '<div class="message-bubble">' + content + '</div>';
            }
            html += '<div class="message-time">' + getCurrentTime() + '</div>';
            html += '</div>';

            wrapper.innerHTML = html;
            chatMessages.appendChild(wrapper);
            setTimeout(() => {
                scrollToBottom();
            }, 100);

        }

        function sendQuickReply(text) {
            appendMessage(text, 'sent');

            // æ¨¡æ‹Ÿå®¢æœå›å¤
            setTimeout(() => {
                let reply = '';
                if (text.includes('å‘å¸ƒå•†å“')) {
                    reply = 'å‘å¸ƒå•†å“æ­¥éª¤ï¼š\n1. ç‚¹å‡»åº•éƒ¨"å‘å¸ƒ"æŒ‰é’®\n2. é€‰æ‹©"å‡ºå”®é’»çŸ³"\n3. å¡«å†™æ¸¸æˆä¿¡æ¯å’Œé’»çŸ³æ•°é‡\n4. è®¾ç½®å•ä»·åæäº¤å³å¯';
                } else if (text.includes('å……å€¼')) {
                    reply = 'å……å€¼æ­¥éª¤ï¼š\n1. è¿›å…¥"æˆ‘çš„"é¡µé¢\n2. ç‚¹å‡»"å……å€¼"æŒ‰é’®\n3. è¾“å…¥å……å€¼é‡‘é¢\n4. é€‰æ‹©æ”¯ä»˜æ–¹å¼å®Œæˆæ”¯ä»˜';
                } else if (text.includes('å®‰å…¨')) {
                    reply = 'æˆ‘ä»¬å¹³å°é‡‡ç”¨æ‹…ä¿äº¤æ˜“æ¨¡å¼ï¼Œèµ„é‡‘ç”±å¹³å°æ‰˜ç®¡ï¼Œäº¤æ˜“å®Œæˆåå†æ”¾æ¬¾ç»™å–å®¶ï¼Œç¡®ä¿ä¹°å–åŒæ–¹æƒç›Šã€‚åŒæ—¶æˆ‘ä»¬æœ‰7*24å°æ—¶é£æ§ç³»ç»Ÿä¿éšœäº¤æ˜“å®‰å…¨ã€‚';
                }
                appendMessage(reply, 'received');
            }, 800);
        }
        function getCurrentTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        }
        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // å…ˆä¸Šä¼ å›¾ç‰‡
            const formData = new FormData();
            formData.append("file", file);

            const upload = await fetch("/api/upload/uploadChatImg", {
                method: "POST",
                body: formData
            }).then(r => r.json());

            const url = upload.url;

            //appendMessage(url, 'sent', true);

            await api("/api/chat/send", "POST", {
                to_id: 0,
                msg_type: 2,
                content: url
            });
            latestMsg();
        }


        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        function selectImage() {
            document.getElementById('imageInput').click();
        }

        let chatMaxId = Number.MAX_SAFE_INTEGER;  // ç”¨äºåˆ†é¡µï¼šå†å²è®°å½•æœ€æ—§çš„ id
        let latestId = 0;                         // ç”¨äºè½®è¯¢ï¼šæœ€æ–°çš„æ¶ˆæ¯ id
        let isChatOpen = false;

        async function loadHistoryFrist() {
            const resp = await api(`/api/chat/records?maxId=${chatMaxId}&limit=20`);
            const list = resp.data;

            if (list.length === 0) return;

            // æ›´æ–° maxIdï¼ˆä¸‹æ¬¡ç»§ç»­åŠ è½½ï¼‰
            chatMaxId = Math.min(...list.map(x => x.id));

            const parent = document.getElementById('chatMessages');

            // ä¿æŒæ»šåŠ¨ä½ç½®ä¸è·³åŠ¨
            const oldScroll = parent.scrollHeight;

            list.forEach(item => {
                appendMessage(
                    item.content,
                    item.from_id === vm.user_id ? "sent" : "received",
                    item.msg_type === 2
                );

                latestId = Math.max(latestId, item.id);
            });

            parent.scrollTop = parent.scrollHeight - oldScroll;
        }
        let isLoadingHistory = false;

        async function loadHistory() {
            if (isLoadingHistory) return; // é˜»æ­¢é‡å¤

            isLoadingHistory = true;
            try {
                const resp = await api(`/api/chat/records?maxId=${chatMaxId}&limit=20`);
                const list = resp.data;

                if (list.length === 0) return;

                chatMaxId = Math.min(...list.map(x => x.id));

                const parent = document.getElementById('chatMessages');

                // è®°å½•æ»šåŠ¨ä½ç½®é˜²æ­¢è·³åŠ¨
                const oldHeight = parent.scrollHeight;

                // â­â­â­ æŒ‰ id ä»å°åˆ°å¤§æ’åºï¼ˆæ—§ â†’ æ–°ï¼‰
                list.sort((a, b) => b.id - a.id);
                // â­â­â­ å…³é”®ï¼šå†å²æ¶ˆæ¯å¿…é¡»åå‘æ’å…¥
                list.forEach(item => {
                    insertHistoryMessage(item);
                    latestId = Math.max(latestId, item.id);
                });

                // æ¢å¤æ»šåŠ¨ä½ç½®
                parent.scrollTop = parent.scrollHeight - oldHeight;
            } finally {
                isLoadingHistory = false;
            }
        }
        function insertHistoryMessage(item) {
            const parent = document.getElementById('chatMessages');

            const wrapper = createMessageNode(item);

            // â­â­â­ å†å²è®°å½•æ’å…¥é¡¶éƒ¨
            parent.insertBefore(wrapper, parent.firstChild);
        }

        function createMessageNode(item) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message-wrapper ' + (item.from_id === vm.user_id ? 'sent' : 'received');

            let html = '';

            if (item.from_id !== vm.user_id) {
                html += '<div class="message-avatar">å®¢</div>';
            }

            html += '<div class="message-content">';

            if (item.msg_type === 2) {
                // å›¾ç‰‡
                html += `<div class="message-bubble image-message">
                        <img src="${item.content}" onclick="previewImage(this.src)">
                     </div>`;
            } else {
                // æ–‡æœ¬
                html += `<div class="message-bubble">${item.content}</div>`;
            }

            html += `<div class="message-time">${formatTime(item.create_time)}</div>`;
            html += `</div>`;

            wrapper.innerHTML = html;
            return wrapper;
        }
        function formatTime(t) {
            const d = new Date(t);
            return d.getHours().toString().padStart(2, '0')
                + ":" +
                d.getMinutes().toString().padStart(2, '0');
        }


        let timer = null;

        function startPolling() {
            if (timer) clearInterval(timer);

            timer = setInterval(async () => {
                if (!isChatOpen) return;
                latestMsg();


            }, 2000);
        }
        async function latestMsg() {
            const resp = await api(`/api/chat/latest?afterId=${latestId}`);
            const list = resp.data;

            list.forEach(item => {
                appendMessage(
                    item.content,
                    item.from_id === vm.user_id ? "sent" : "received",
                    item.msg_type === 2
                );
                latestId = item.id;
            });
        }

        loadUnread();

        // éŸ³é¢‘å¯¹è±¡ï¼ˆå…¨å±€å¤ç”¨ï¼‰
        const newMsgAudio = new Audio("/sounds/msgnotice.mp3");
        newMsgAudio.volume = 0.6;   // éŸ³é‡ 0 ~ 1

        async function loadUnread() {
            const resp = await api("/api/chat/unread");
            vm.unreadChatCount = resp.count;
            if (vm.unreadChatCount > 0) {
                //æ’­æ”¾éŸ³é¢‘
                playNewMsgSound();
            }
            vm.$forceUpdate();
        }

        setInterval(loadUnread, 10000);  // 10ç§’åˆ·æ–°ä¸€æ¬¡
        function playNewMsgSound() {
            // iOS å¿…é¡»å…ˆæœ‰ç”¨æˆ·äº¤äº’æ‰å…è®¸æ’­æ”¾
            newMsgAudio.currentTime = 0;
            newMsgAudio.play().catch(err => {
                console.log("éŸ³é¢‘æ’­æ”¾è¢«é˜»æ­¢ï¼Œéœ€è¦ç”¨æˆ·æ“ä½œä¸€æ¬¡å±å¹•æ‰å¯æ’­æ”¾", err);
            });
        }

    </script>


    <script>
        // é¢„è§ˆå›¾ç‰‡
        function previewImage(src) { document.getElementById('previewImage').src = src; document.getElementById('imagePreviewModal').classList.add('active'); }
        // å…³é—­å›¾ç‰‡é¢„è§ˆ
        function closeImagePreview() { document.getElementById('imagePreviewModal').classList.remove('active'); }
        document.getElementById("chatMessages").addEventListener("scroll", async function () {
            if (this.scrollTop < 50) {
                await loadHistory();
            }
        });

        // ç‚¹å‡»ä¸Šä¼ 
        document.getElementById('qrcodeFile').addEventListener('change', async function () {
            const file = this.files[0];
            if (!file) return;

            // é¢„è§ˆ
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('qrcodePreview').src = e.target.result;
                document.getElementById('qrcodePreview').style.display = "block";
                document.getElementById('uploadPlaceholder').style.display = "none";
            };
            reader.readAsDataURL(file);

            // ä¸Šä¼ åˆ°æœåŠ¡å™¨
            const formData = new FormData();
            formData.append("file", file);

            const res = await fetch("/api/upload/qrcode", {
                method: "POST",
                body: formData
            });

            const data = await res.json();
            if (data.code === 0) {
                // æŠŠè¿”å›çš„å›¾ç‰‡URLæŒ‚åˆ° tinyVue
                vm.withdrawForm.pay_url = data.url;
            } else {
                alert(data.msg);
            }
        });
    </script>


    <script>
        (function () {
            // åŸ‹ç‚¹æ¥å£
            const url = "/api/stat/page-view";
            const token = localStorage.getItem("token");
            // é¡µé¢æ•°æ®
            const data = {
                page: "æˆ‘çš„é¡µé¢",
                referrer: document.referrer,
                ua: navigator.userAgent,
                ts: Date.now()
            };

            fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    ...(token ? { "Authorization": "Bearer " + token } : {})
                },
                body: data ? JSON.stringify(data) : null
            });
        })();



        // æ»šåŠ¨ç›‘å¬ - è‡ªåŠ¨ä¸‹ä¸€é¡µ
        window.addEventListener('scroll', () => {
            if (vm.isLoading || vm.finished) return;

            const scrollTop = window.scrollY;
            const clientHeight = window.innerHeight;
            const scrollHeight = document.body.scrollHeight;

            // è·åº•éƒ¨ < 150 åƒç´ æ—¶åŠ è½½ä¸‹ä¸€é¡µ
            if (scrollTop + clientHeight >= scrollHeight - 150) {
                vm.pageIndex++;
                loadData(true); // è¿½åŠ åŠ è½½
            }
        });
    </script>
</body>
</html>
