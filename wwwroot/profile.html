<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ - GameTrade</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div id="app">

        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">ğŸ’</span>
                    <span class="logo-text">GameTrade</span>
                </div>
                <button class="theme-toggle-btn" onclick="toggleTheme()">ğŸŒ“</button>
            </div>
        </header>

        <main class="main-content">

            <!-- ç”¨æˆ·ä¿¡æ¯ -->
            <div class="profile-header">
                <div class="user-info">
                    <div class="user-avatar">ğŸ‘¤</div>
                    <div class="user-details">
                        <h2 class="user-name">{{ nickname }}</h2>
                        <p class="user-id">{{ login_name }}</p>
                    </div>
                </div>
            </div>

            <!-- ä½™é¢ -->
            <div class="balance-section">
                <div class="balance-card">
                    <div class="balance-label">è´¦æˆ·ä½™é¢</div>
                    <div class="balance-amount">Â¥ {{ amount }}</div>
                    <div class="balance-actions">
                        <button class="btn-action" v-on:click="openRecharge" >å……å€¼</button>
                        <button class="btn-action" v-on:click="openWithdraw"  v-if="user_type==0">æç°</button>
                        <button class="btn-action" v-on:click="openAdminWithdraw" v-if="user_type==1">æç°å¤„ç†</button>
                    </div>
                    <div class="balance-record">
                        <a href="records.html">æŸ¥çœ‹å……æè®°å½•</a>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab-btn"
                            :class="{active: tab==='selling'}"
                            v-on:click="switchTab('selling')">
                        åœ¨å”®å•†å“
                    </button>

                    <button class="tab-btn"
                            :class="{active: tab==='purchased'}"
                            v-on:click="switchTab('purchased')">
                        è´­ä¹°è®°å½•
                    </button>

                    <button class="tab-btn"
                            :class="{active: tab==='sold'}"
                            v-on:click="switchTab('sold')">
                        å‡ºå”®è®°å½•
                    </button>

                    <button class="tab-btn"
                            :class="{active: tab==='amount'}"
                            v-on:click="switchTab('amount')">
                        ä½™é¢è®°å½•
                    </button>
                </div>

                <!-- ===== åœ¨å”®å•†å“ ===== -->
                <div class="tab-content" v-if="tab==='selling'">
                    <div class="record-list">
                        <div class="no-data" v-if="selling.length === 0">
                            æš‚æ— åœ¨å”®å•†å“
                        </div>
                        <div class="record-item" v-for="item in selling" v-for-template>
                            <div class="record-info">
                                <div class="record-title">{{ item.diamond_amount }} ğŸ’</div>
                                <div class="record-meta">å•ä»·: Â¥{{ item.unit_price }}/é’»</div>
                                <div class="record-time">å‘å¸ƒäº {{ item.create_time }}</div>
                            </div>

                            <div class="record-right">
                                <div class="record-amount">Â¥ {{ item.total_price }}</div>
                                <button class="btn-small btn-danger"
                                        v-on:click="offSale(item.id)">
                                    ä¸‹æ¶
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== è´­ä¹°è®°å½• ===== -->
                <div class="tab-content" v-if="tab==='purchased'">
                    <div class="record-list">
                        <div class="no-data" v-if="purchased.length === 0">
                            æš‚æ— è´­ä¹°è®°å½•
                        </div>
                        <div class="record-item" v-for="order in purchased">
                            <div class="record-info">
                                <div class="record-title">{{ order.diamond_amount }} ğŸ’</div>
                                <div class="record-meta">{{ order.order_no }}</div>
                                <div class="record-meta">å–å®¶: {{ order.seller_name }}</div>
                                <div class="record-time">{{ order.create_time }}</div>
                            </div>

                            <div class="record-right">
                                <div class="record-amount"> Â¥ -{{ order.total_price }}</div>
                                <div class="record-status status-completed">å·²å®Œæˆ</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== å‡ºå”®è®°å½• ===== -->
                <div class="tab-content" v-if="tab==='sold'">
                    <div class="record-list">
                        <div class="no-data" v-if="sold.length === 0">
                            æš‚æ— å‡ºå”®è®°å½•
                        </div>
                        <div class="record-item" v-for="order in sold">
                            <div class="record-info">
                                <div class="record-title">{{ order.diamond_amount }} ğŸ’</div>
                                <div class="record-meta">{{ order.order_no }}</div>
                                <div class="record-meta">ä¹°å®¶: {{ order.buyer_name }}</div>
                                <div class="record-time">{{ order.create_time }}</div>
                            </div>

                            <div class="record-right">
                                <div class="record-amount"> Â¥ +{{ order.total_price }}</div>
                                <div class="record-status status-completed">å·²å®Œæˆ</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== ä½™é¢è®°å½• ===== -->
                <div class="tab-content" v-if="tab==='amount'">
                    <div class="record-list">
                        <div class="no-data" v-if="balanceLogs.length === 0">
                            æš‚æ— è®°å½•
                        </div>
                        <div class="record-item" v-for="order in balanceLogs">
                            <div class="record-info">
                                <div class="record-title">{{ order.before_amount }} å˜ {{ order.after_amount }}</div>
                                <div class="record-meta">{{ order.remark }}</div>
                                <div class="record-time">{{ order.create_time }}</div>
                            </div>

                            <div class="record-right">
                                <div class="record-amount"> Â¥ {{ order.amount }}</div>
                                <div class="record-status status-completed">å·²å®Œæˆ</div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </main>
        <div v-if="withdrawModal" class="modal" style="display:none">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>æç°</h2>
                    <span class="modal-close" v-on:click="withdrawModal=false">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="balance-info">
                        <span>å¯æç°ä½™é¢:</span>
                        <span class="balance-value">Â¥ {{ amount }}</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æç°é‡‘é¢</label>
                        <input type="number" class="form-input" v-model="withdrawForm.amount" placeholder="è¯·è¾“å…¥æç°é‡‘é¢" min="1" max="{{amount}}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æç°æ–¹å¼</label>
                        <select class="form-input" v-model="withdrawForm.pay_channel">
                            <option value="ZFB">æ”¯ä»˜å®</option>
                            <option value="WX">å¾®ä¿¡</option>
                            <option value="CARD">é“¶è¡Œå¡</option>
                            <option value="USDT">USDT</option>
                        </select>
                    </div>
                    <div class="form-section">
                        <label class="form-label">æ”¶æ¬¾äºº</label>
                        <div class="form-group">
                            <input type="text" class="form-input" id="paymentInfo" v-model="withdrawForm.name" placeholder="è¯·è¾“å…¥æ”¶æ¬¾ä¿¡æ¯">
                        </div>
                    </div>
                    <!-- æ”¶æ¬¾äºŒç»´ç ä¸Šä¼ åŒºåŸŸ -->
                    <div class="form-group" id="qrcodeUploadSection"  v-if="withdrawForm.pay_channel=='WX'||withdrawForm.pay_channel=='ZFB'">
                        <label class="form-label">ä¸Šä¼ æ”¶æ¬¾ç </label>
                        <div class="qr-upload" id="uploadArea" onclick="document.getElementById('qrcodeFile').click()">
                            <input type="file" id="qrcodeFile" accept="image/*" style="display: none; " v-model="withdrawForm.pay_url">
                            <div class="upload-placeholder" id="uploadPlaceholder">
                                <span class="upload-icon">ğŸ“·</span>
                                <span class="upload-hint">ä¸Šä¼ æ”¶æ¬¾ç ,æ”¯æŒ JPGã€PNG æ ¼å¼</span>
                            </div>
                            <img id="qrcodePreview" class="qrcode-preview" style="display: none;">
                        </div>
                    </div>

                    <!-- æ”¶æ¬¾ä¿¡æ¯å¡«å†™åŒºåŸŸ -->
                    <div class="form-section" v-if="withdrawForm.pay_channel=='CARD'||withdrawForm.pay_channel=='USDT'">
                        <label class="form-label" v-if="withdrawForm.pay_channel=='CARD'">é“¶è¡Œå¡å·</label>
                        <label class="form-label" v-if="withdrawForm.pay_channel=='USDT'">USDTåœ°å€</label>
                        <div class="form-group">
                            <input type="text" class="form-input" v-model="withdrawForm.pay_info" placeholder="è¯·è¾“å…¥æ”¶æ¬¾ä¿¡æ¯">
                        </div>
                    </div>
                    <div class="withdraw-note">
                        æç°å°†åœ¨1-3ä¸ªå·¥ä½œæ—¥å†…åˆ°è´¦ï¼Œæ‰‹ç»­è´¹ä¸ºæç°é‡‘é¢çš„1%
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" v-on:click="withdrawModal=false">å–æ¶ˆ</button>
                    <button class="btn-primary" v-on:click="confirmWithdraw">ç¡®è®¤æç°</button>
                </div>
            </div>
        </div>
        <!-- åº•éƒ¨å¯¼èˆª -->
        <nav class="bottom-nav">
            <a href="index.html" class="nav-item">
                <span class="nav-icon">ğŸ </span>
                <span class="nav-label">é¦–é¡µ</span>
            </a>
            <a href="publish.html" class="nav-item">
                <span class="nav-icon">â•</span>
                <span class="nav-label">å‘å¸ƒ</span>
            </a>
            <a href="profile.html" class="nav-item active">
                <span class="nav-icon">ğŸ‘¤</span>
                <span class="nav-label">æˆ‘çš„</span>
            </a>
        </nav>

    </div>
    <script src="js/tinyVue.js"></script>
    <script src="js/common.js"></script>


    <script>
        const vm = tinyVue({
            el: "#app",
            data: {
                withdrawModal: false,
                nickname: "",
                login_name: "",
                user_type:0,
                amount: 0,
                tab: "selling",
                selling: [],
                purchased: [],
                sold: [],
                balanceLogs: [],

                withdrawForm: {
                    amount: 0,
                    pay_channel: '',
                    pay_url: '',
                    pay_info: '',
                    name: '',
                },
            }
        });

        // åŠ è½½æ•°æ®
        async function loadData() {
            const [user, s] = await Promise.all([
                api("/api/user/queryUser"),
                api("/api/diamond/my-selling"),
                
            ]);

            vm.nickname = user.data.nickname;
            vm.login_name = user.data.login_name;
            vm.user_type = user.data.user_type;
            vm.amount = user.data.amount;
            vm.selling = s.data;

            vm.$forceUpdate();
        }

        
        async function switchTab(t) {
            vm.tab = t;
            if (t =='selling') {
                const s = await api("/api/diamond/my-selling");
                if(s&&s.data)
                    vm.selling = s.data;
            }
            if (t =='purchased') {
                const s = await api("/api/order/my-purchased");
                if(s&&s.data)
                    vm.purchased = s.data;
            }
            if (t =='sold') {
                const s = await api("/api/order/my-sold");
                if(s&&s.data)
                    vm.sold = s.data;
            }
            if (t =='amount') {
                const s = await api("/api/user/balance-log");
                if(s&&s.data)
                    vm.balanceLogs = s.data;
            }
            vm.$forceUpdate();
        };

        vm.offSale = async function offSale(id) {
            if (!confirm("ç¡®è®¤ä¸‹æ¶ï¼Ÿ")) return;
            await api(`/api/diamond/off-sale/${id}`, "POST");
            loadData();
        };

        vm.openRecharge = function () {
            alert("åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­");
        };

        vm.openWithdraw = function () {

            vm.withdrawForm = {
                amount: 0,
                pay_channel: '',
                pay_url: '',
                pay_info: '',
                name: '',
            };
            vm.withdrawModal = true;
        };

        vm.openAdminWithdraw = function () {
            window.location.href = "admin-withdraw.html"
        }
        vm.openRecharge = function () {
            window.location.href = "recharge.html"
        }
        vm.confirmWithdraw = async function () {
            if (!vm.withdrawForm.amount || vm.withdrawForm.amount <= 0) {
                alert("è¯·è¾“å…¥æç°é‡‘é¢");
                return;
            }

            if (!vm.withdrawForm.pay_channel) {
                alert("è¯·é€‰æ‹©æç°æ–¹å¼");
                return;
            }

            if (!vm.withdrawForm.name) {
                alert("è¯·è¾“å…¥æ”¶æ¬¾äººå§“å");
                return;
            }

            if (!vm.withdrawForm.pay_url && (vm.withdrawForm.pay_channel === "WX" || vm.withdrawForm.pay_channel === "ZFB")) {
                alert("è¯·ä¸Šä¼ æ”¶æ¬¾äºŒç»´ç ");
                return;
            }

            if (!vm.withdrawForm.pay_info && (vm.withdrawForm.pay_channel === "CARD" )) {
                alert("è¯·è¾“å…¥å¡å·");
                return;
            }

            if (!vm.withdrawForm.pay_info && (vm.withdrawForm.pay_channel === "USDT" )) {
                alert("è¯·è¾“å…¥USDTåœ°å€");
                return;
            }

            const res = await api("/api/finance/withdraw", "POST", vm.withdrawForm);

            if (!res) return;
            vm.withdrawModal = false;
            loadData();
            alert("æç°ç”³è¯·å·²æäº¤,é¢„è®¡1-3ä¸ªå·¥ä½œæ—¥åˆ°è´¦ï¼");
        };


        loadData();
    </script>


    <script>
        
        // ç‚¹å‡»ä¸Šä¼ 
        document.getElementById('qrcodeFile').addEventListener('change', async function () {
            const file = this.files[0];
            if (!file) return;

            // é¢„è§ˆ
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('qrcodePreview').src = e.target.result;
                document.getElementById('qrcodePreview').style.display = "block";
                document.getElementById('uploadPlaceholder').style.display = "none";
            };
            reader.readAsDataURL(file);

            // ä¸Šä¼ åˆ°æœåŠ¡å™¨
            const formData = new FormData();
            formData.append("file", file);

            const res = await fetch("/api/upload/qrcode", {
                method: "POST",
                body: formData
            });

            const data = await res.json();
            if (data.code === 0) {
                // æŠŠè¿”å›çš„å›¾ç‰‡URLæŒ‚åˆ° tinyVue
                vm.withdrawForm.pay_url = data.url;
            } else {
                alert(data.msg);
            }
        });
    </script>

</body>
</html>
