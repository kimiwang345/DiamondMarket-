<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¡µé¢ç»Ÿè®¡ - ç®¡ç†åå°</title>
    <link rel="stylesheet" href="admin-stats-styles.css">
    <!--<link rel="stylesheet" href="styles.css">-->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body>
    <div class="container" id="app">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="header">

            <div class="header-content">
                <a href="profile.html" class="back-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg>
                </a>
                <div class="logo">
                    <span class="logo-text">æŠ¥è¡¨ç»Ÿè®¡</span>
                </div>
                <button class="theme-toggle-btn" onclick="toggleTheme2()">ğŸŒ“</button>
            </div>
        </header>

        <!-- æ—¥æœŸç­›é€‰ -->
        <div class="date-filter">
            <div class="date-tabs">
                <button class="date-tab active" data-days="7">è¿‘7å¤©</button>
                <button class="date-tab" data-days="14">è¿‘14å¤©</button>
                <button class="date-tab" data-days="30">è¿‘30å¤©</button>
            </div>
        </div>

        <!-- æ€»è§ˆå¡ç‰‡ -->
        <div class="stats-overview">
            <div class="overview-card">
                <div class="overview-icon pv-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                        <circle cx="12" cy="12" r="3" />
                    </svg>
                </div>
                <div class="overview-info">
                    <span class="overview-label">æ€»PV</span>
                    <span class="overview-value" id="totalPV">{{reportData.totalPV}}</span>
                </div>
            </div>
            <div class="overview-card">
                <div class="overview-icon uv-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" />
                    </svg>
                </div>
                <div class="overview-info">
                    <span class="overview-label">æ€»UV</span>
                    <span class="overview-value" id="totalUV">{{reportData.totalUV}}</span>
                </div>
            </div>
            <div class="overview-card">
                <div class="overview-icon avg-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                        <line x1="3" y1="9" x2="21" y2="9" />
                        <line x1="9" y1="21" x2="9" y2="9" />
                    </svg>
                </div>
                <div class="overview-info">
                    <span class="overview-label">äººå‡PV</span>
                    <span class="overview-value" id="avgPV">{{reportData.avgPV}}</span>
                </div>
            </div>
        </div>

        <!-- PV/UVè¶‹åŠ¿å›¾ -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">PV/UVè¶‹åŠ¿</h3>
                <div class="chart-legend">
                    <span class="legend-item"><i class="legend-dot pv"></i>PV</span>
                    <span class="legend-item"><i class="legend-dot uv"></i>UV</span>
                </div>
            </div>
            <div id="trendChart" class="chart-container"></div>
        </div>

        <!-- é¡µé¢æ’è¡Œ -->
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">é¡µé¢è®¿é—®æ’è¡Œ</h3>
                <div class="chart-tabs">
                    <button class="chart-tab active" data-type="pv">æŒ‰PV</button>
                    <button class="chart-tab" data-type="uv">æŒ‰UV</button>
                </div>
            </div>
            <div id="rankChart" class="chart-container"></div>
        </div>


        <!-- å®æ—¶è®¿é—® -->
        <div class="realtime-card">
            <div class="realtime-header">
                <h3 class="chart-title">
                    <span class="realtime-dot"></span>
                    å®æ—¶è®¿é—®
                </h3>
                <span class="realtime-count">å½“å‰åœ¨çº¿: <strong>{{onlineCount}}</strong> äºº</span>
            </div>
            <div class="realtime-list" id="realtimeList">

            </div>
        </div>

    </div>
    <!-- å…¬å…±è„šæœ¬ï¼štinyVue + api/ä¸»é¢˜ -->
    <script src="js/tinyVue.js"></script>
    <script src="js/common.js"></script>
    <script>
        function toggleTheme2() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
        initTheme();
        // åˆå§‹åŒ–ä¸»é¢˜
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
        }

        const vm = tinyVue({
            el: "#app",
            data: {
                "onlineCount":0,
                "reportData": {
                    "totalPV": 0,
                    "totalUV": 0,
                    "avgPV": 0,
                    "trends": [
                    ],
                    "rank": [
                    ],
                    "table": [
                        {
                            "page": "/diamond.html",
                            "pv": 45231,
                            "uv": 8912,
                            "avgStay": "3m 24s",
                            "bounce": "32%"
                        }
                    ]
                },
                "realtime":[],
            }
        });
        loadData(7);
        async function loadData(days) {
            const resp = await api("/api/adminStats/initData?days=" + days);
            vm.reportData = resp.data;
            vm.$forceUpdate();
            initTrendChart();
            initRankChart();

        }



        // æ—¥æœŸæ ‡ç­¾åˆ‡æ¢
        document.querySelectorAll('.date-tab').forEach(tab => {
            tab.addEventListener('click', function () {
                document.querySelectorAll('.date-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                const days = this.dataset.days;
                loadDataByDays(days);
            });
        });

        // å›¾è¡¨æ ‡ç­¾åˆ‡æ¢
        document.querySelectorAll('.chart-tab').forEach(tab => {
            tab.addEventListener('click', function () {
                document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                const type = this.dataset.type;
                updateRankChart(type);
                
            });
        });

        // æŒ‰æ—¥æœŸæŸ¥è¯¢
        function searchByDate() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if (startDate && endDate) {
                console.log('æŸ¥è¯¢æ—¥æœŸèŒƒå›´:', startDate, '-', endDate);
                // è¿™é‡Œè°ƒç”¨APIè·å–æ•°æ®
            }
        }


        // åŠ è½½æ•°æ®
        function loadDataByDays(days) {
            console.log('åŠ è½½æœ€è¿‘', days, 'å¤©æ•°æ®');
            loadData(days);
            // è¿™é‡Œè°ƒç”¨APIè·å–æ•°æ®å¹¶æ›´æ–°å›¾è¡¨
        }

        // åˆå§‹åŒ–è¶‹åŠ¿å›¾
        function initTrendChart() {
            const chart = echarts.init(document.getElementById('trendChart'));
            const colors = getThemeColors();

            const dates = [];
            const pvData = [];
            const uvData = [];
            var trends = vm.reportData.trends;
            trends.forEach((item => {
                dates.push(item["date"].split("T")[0]);
                pvData.push(item["pv"]);
                uvData.push(item["uv"]);
            }))

            const option = {
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    borderColor: 'transparent',
                    textStyle: { color: '#fff' }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: dates,
                    axisLine: { lineStyle: { color: colors.lineColor } },
                    axisLabel: { color: colors.textColor }
                },
                yAxis: {
                    type: 'value',
                    axisLine: { show: false },
                    splitLine: { lineStyle: { color: colors.lineColor } },
                    axisLabel: { color: colors.textColor }
                },
                series: [
                    {
                        name: 'PV',
                        type: 'line',
                        smooth: true,
                        data: pvData,
                        lineStyle: { color: colors.pvColor, width: 3 },
                        itemStyle: { color: colors.pvColor },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(79, 172, 254, 0.3)' },
                                { offset: 1, color: 'rgba(79, 172, 254, 0)' }
                            ])
                        }
                    },
                    {
                        name: 'UV',
                        type: 'line',
                        smooth: true,
                        data: uvData,
                        lineStyle: { color: colors.uvColor, width: 3 },
                        itemStyle: { color: colors.uvColor },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(245, 166, 35, 0.3)' },
                                { offset: 1, color: 'rgba(245, 166, 35, 0)' }
                            ])
                        }
                    }
                ]
            };

            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        // åˆå§‹åŒ–æ’è¡Œå›¾
        function initRankChart(type = 'pv') {
            const chart = echarts.init(document.getElementById('rankChart'));
            const colors = getThemeColors();

            const pages = [];
            const pvValues = [];
            const uvValues = [];

            var rank = vm.reportData.rank;
            rank.forEach((item => {
                pages.push(item["page"]);
                pvValues.push(item["pv"]);
                uvValues.push(item["uv"]);
            }))

            const data = type === 'pv' ? pvValues : uvValues;
            const color = type === 'pv' ? colors.pvColor : colors.uvColor;

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    borderColor: 'transparent',
                    textStyle: { color: '#fff' }
                },
                grid: {
                    left: '3%',
                    right: '8%',
                    bottom: '3%',
                    top: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'value',
                    axisLine: { show: false },
                    splitLine: { lineStyle: { color: colors.lineColor } },
                    axisLabel: { color: colors.textColor }
                },
                yAxis: {
                    type: 'category',
                    data: pages.reverse(),
                    axisLine: { lineStyle: { color: colors.lineColor } },
                    axisLabel: { color: colors.textColor }
                },
                series: [
                    {
                        type: 'bar',
                        data: data.reverse(),
                        barWidth: '50%',
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                { offset: 0, color: color },
                                { offset: 1, color: type === 'pv' ? '#00f2fe' : '#ffc107' }
                            ]),
                            borderRadius: [0, 4, 4, 0]
                        },
                        label: {
                            show: true,
                            position: 'right',
                            color: colors.textColor,
                            formatter: '{c}'
                        }
                    }
                ]
            };

            chart.setOption(option);
            window.trendRankChart = chart;
            window.addEventListener('resize', () => chart.resize());
        }

        // æ›´æ–°æ’è¡Œå›¾
        function updateRankChart(type) {
            initRankChart(type);
        }

      

        // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
        function initCharts() {
            initTrendChart();
            initRankChart('pv');
        }

        // =============== â­ å®æ—¶è®¿é—®ï¼ˆä»åç«¯è·å–ï¼‰ ===============
        async function updateRealtime() {
            try {
                const resp = await api("/api/adminStats/realtime");
                const list = resp.list || [];
                vm.onlineCount = resp.onlineCount || 0;
                vm.$forceUpdate();
                renderRealtime(list);
            } catch (err) {
                console.error("å®æ—¶è®¿é—®åŠ è½½å¤±è´¥:", err);
            }
        }


        // =============== â­ æ¸²æŸ“å®æ—¶è®¿é—® UI ===============
        function renderRealtime(list) {
            const container = document.getElementById("realtimeList");
            container.innerHTML = ""; // æ¸…ç©º

            list.forEach((item, index) => {
                const div = document.createElement("div");
                div.className = "realtime-item";

                // æ—¶é—´æ ¼å¼
                const seconds = getSecondsAgo(item.time);
                const timeText = seconds <= 2 ? "åˆšåˆš" : `${seconds}ç§’å‰`;

                div.innerHTML = `
            <span class="realtime-time">${timeText}</span>
            <span class="realtime-page">${item.page}</span>
            <span class="realtime-user">ç”¨æˆ· #${item.nickname}</span>
        `;

                container.appendChild(div);
            });
        }


        // =============== â­ å·¥å…·å‡½æ•°ï¼šè®¡ç®—æ—¶é—´å·®ç§’æ•° ===============
        function getSecondsAgo(dateStr) {
            const now = new Date();
            const t = new Date(dateStr);
            return Math.max(1, Math.floor((now - t) / 1000));
        }


        // =============== â­ å¯åŠ¨å®šæ—¶ä»»åŠ¡ ===============
        function startRealtimeMonitor() {
            updateRealtime();         // ç«‹å³è¿è¡Œä¸€æ¬¡
            setInterval(updateRealtime, 5000);  // æ¯ 5 ç§’åˆ·æ–°
        }

        // é¡µé¢åŠ è½½åè¿è¡Œ
        document.addEventListener("DOMContentLoaded", startRealtimeMonitor);


        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            initTheme();
            //initCharts();

            // è®¾ç½®é»˜è®¤æ—¥æœŸ
            //const today = new Date();
            //const weekAgo = new Date(today);
            //weekAgo.setDate(weekAgo.getDate() - 7);

            //document.getElementById('endDate').value = today.toISOString().split('T')[0];
            //document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
        });

        // è·å–ä¸»é¢˜è‰²
        function getThemeColors() {
            const isDark = document.body.getAttribute('data-theme') !== 'light';
            return {
                textColor: isDark ? '#a0a0a0' : '#666666',
                lineColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
                pvColor: '#4facfe',
                uvColor: '#f5a623',
                backgroundColor: 'transparent'
            };
        }
    </script>
</body>
</html>
