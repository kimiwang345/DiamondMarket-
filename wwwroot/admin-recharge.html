<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç°å¤„ç† - ç®¡ç†åå°</title>
    <!-- æ›´æ¢ä¸ºç‹¬ç«‹çš„ç®¡ç†åå°æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">ğŸ’</span>
                    <span class="logo-text">å……å€¼å¤„ç†</span>
                </div>
                <button class="theme-toggle-btn" onclick="toggleTheme()">ğŸŒ“</button>
            </div>
        </header>
        <!-- æ›´æ–°ç­›é€‰å™¨ç»“æ„ -->
        <div class="filter-container">
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterByStatus('0', this)">å¾…å¤„ç†</button>
                <button class="filter-tab" onclick="filterByStatus('1', this)">å·²å®Œæˆ</button>
            </div>
        </div>

        <!-- æ›´æ–°æç°åˆ—è¡¨ç»“æ„ -->
        <div class="withdraw-list">
            <div class="records-list">

                <div class="no-data" v-if="rechargeLogs.length===0">
                    æš‚æ— å……å€¼è®°å½•
                </div>

                <div class="admin-record-item" v-for="item in rechargeLogs">
                    <div class="admin-record-item-body">
                        <div class="record-info">
                            <div class="record-title">{{ getChannel(item.pay_channel) }} ğŸ’</div>
                            <div class="record-title">{{ item.nickname }}({{item.login_name}})</div>
                            <div class="record-meta">{{ item.order_no }}</div>
                            <div class="record-time">{{ item.create_time }}</div>
                        </div>

                        <div class="record-right">
                            <div class="record-amount">Â¥ +{{ item.amount }}</div>
                            <div class="record-status status-pending" v-if="item.status==0">æ”¯ä»˜ä¸­</div>
                            <div class="record-status status-completed" v-if="item.status==1">å·²å®Œæˆ</div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn reject" v-on:click="rejectRecharge(item)" v-if="item.status==0">æ‹’ç»</button>
                        <button class="action-btn approve" v-on:click="completeRecharge(item)" v-if="item.status==0">ç¡®è®¤å®Œæˆ</button>
                    </div>
                </div>

            </div>
        </div>
        <!-- Toastæç¤º -->
        <div class="toast" id="toast"></div>
        <!-- åº•éƒ¨å¯¼èˆª -->
        <nav class="bottom-nav">
            <a href="index.html" class="nav-item">
                <span class="nav-icon">ğŸ </span>
                <span>é¦–é¡µ</span>
            </a>
            <a href="admin-recharge.html" class="nav-item active">
                <span class="nav-icon">ğŸ’°</span>
                <span>å……å€¼ç®¡ç†</span>
            </a>
            <a href="profile.html" class="nav-item">
                <span class="nav-icon">ğŸ‘¤</span>
                <span>æˆ‘çš„</span>
            </a>
        </nav>
    </div>
    <script src="js/tinyVue.js"></script>
    <script src="js/common.js"></script>
    <script>
        const vm = tinyVue({
            el: "#app",
            data: {
                rejectModal: false,
                withdrawLogs: [],
                status: -1,
                rejectReason:"",
                rejectId: 0,

                // ===== åˆ†é¡µ =====
                pageIndex: 1,
                pageSize: 10,
                total: 0,
                totalPages: 1,

                // ===== è‡ªåŠ¨åŠ è½½æ§åˆ¶ =====
                isLoading: false,
                finished: false
            },

            methods: {
                getStatus(status) {
                    switch (status) {
                        case 0: return "å¾…å¤„ç†";
                        case 1: return "å¤„ç†ä¸­";
                        case 2: return "å·²å®Œæˆ";
                        case 3: return "å·²å…³é—­";
                    }
                    return "æœªçŸ¥çŠ¶æ€";
                },
                getChannel(channel) {
                    switch (channel) {
                        case 'WX': return "å¾®ä¿¡";
                        case 'ZFB': return "æ”¯ä»˜å®";
                        case "CARD": return "é“¶è¡Œå¡";
                        case "usdt": return "USDT";
                        case "manual": return "äººå·¥æˆæƒ";
                    }
                    return "æœªçŸ¥";
                },
                copyText(text) {
                    navigator.clipboard.writeText(text).then(() => {
                        showToast('å·²å¤åˆ¶: ' + text);
                    }).catch(() => {
                        showToast('å¤åˆ¶å¤±è´¥');
                    });
                },
            }
        });

        // åŠ è½½æ•°æ®
        async function loadData(append = false, status=0) {
            if (vm.isLoading) return;
            vm.isLoading = true;
            try {
                const p = await api("/api/finance/admin-recharge-logs", "POST", {
                    status: status,
                    pageIndex: vm.pageIndex,
                    pageSize: vm.pageSize
                });

                if (p) {
                    if (append) {
                        // è¿½åŠ åˆ°åˆ—è¡¨æœ«å°¾
                        vm.rechargeLogs = vm.rechargeLogs.concat(p.data || []);
                    } else {
                        // é¦–æ¬¡åŠ è½½ / åˆ‡æ¢çŠ¶æ€
                        vm.rechargeLogs = p.data || [];
                    }

                    vm.total = p.total || 0;
                    vm.totalPages = Math.max(1, Math.ceil(vm.total / vm.pageSize));

                    // å¦‚æœå·²ç»åˆ°æœ€åä¸€é¡µ
                    vm.finished = vm.pageIndex >= vm.totalPages;
                }

                vm.isLoading = false;
                vm.$forceUpdate();
            } finally {
                vm.isLoading = false;
            }
        }

        loadData(false,0);

        // ç­›é€‰çŠ¶æ€
        function filterByStatus(status, btn) {
            // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            btn.classList.add('active');

           
            vm.status = status;
            vm.pageIndex = 1;
            vm.finished = false;
            vm.$forceUpdate();
            loadData(false,status);
        }

        // å®Œæˆæç°
        async function completeRecharge(item) {
            if (confirm('ç¡®è®¤æ ¸å¯¹è¿‡ä¿¡æ¯ï¼Œæ‰‹åŠ¨å®Œæˆè¯¥ç¬”å……å€¼ï¼Ÿ')) {
                const res = await api(`/api/finance/completeRecharge/${item.id}`, "POST");
                if (!res) return;
                showToast('å·²å®Œæˆ');
                loadData(false,0);
            }
        }

        // æ‹’ç»æç°
        async function rejectRecharge(item) {
            if (confirm('ç¡®è®¤æ ¸å¯¹è¿‡ä¿¡æ¯ï¼Œæ‰‹åŠ¨å–æ¶ˆè¯¥ç¬”å……å€¼ï¼Ÿ')) {
                const res = await api(`/api/finance/rejectRecharge/${item.id}`, "POST");
                if (!res) return;
                showToast('å·²å®Œæˆ');
                loadData(false, 0);
            }
        }

        // æ˜¾ç¤ºæç¤º
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // æ»šåŠ¨ç›‘å¬ - è‡ªåŠ¨ä¸‹ä¸€é¡µ
        window.addEventListener('scroll', () => {
            if (vm.isLoading || vm.finished) return;

            const scrollTop = window.scrollY;
            const clientHeight = window.innerHeight;
            const scrollHeight = document.body.scrollHeight;

            // è·åº•éƒ¨ < 150 åƒç´ æ—¶åŠ è½½ä¸‹ä¸€é¡µ
            if (scrollTop + clientHeight >= scrollHeight - 150) {
                vm.pageIndex++;
                loadData(true, vm.status); // è¿½åŠ åŠ è½½
            }
        });
    </script>
</body>
</html>
