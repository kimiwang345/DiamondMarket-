<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç°å¤„ç† - ç®¡ç†åå°</title>
    <!-- æ›´æ¢ä¸ºç‹¬ç«‹çš„ç®¡ç†åå°æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">ğŸ’</span>
                    <span class="logo-text">æç°å¤„ç†</span>
                </div>
                <button class="theme-toggle-btn" onclick="toggleTheme()">ğŸŒ“</button>
            </div>
        </header>

        <!-- æ›´æ–°ç»Ÿè®¡å¡ç‰‡ç»“æ„ -->
        <!--<div class="stats-container">
        <div class="stat-card pending">
            <span class="stat-value">5</span>
            <span class="stat-label">å¾…å¤„ç†</span>
        </div>
        <div class="stat-card success">
            <span class="stat-value">12</span>
            <span class="stat-label">ä»Šæ—¥å®Œæˆ</span>
        </div>
        <div class="stat-card">
            <span class="stat-value">Â¥8.5K</span>
            <span class="stat-label">æ€»é‡‘é¢</span>
        </div>
    </div>-->
        <!-- æ›´æ–°ç­›é€‰å™¨ç»“æ„ -->
        <div class="filter-container">
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterByStatus('-1', this)">å…¨éƒ¨</button>
                <button class="filter-tab" onclick="filterByStatus('0', this)">å¾…å¤„ç†</button>
                <button class="filter-tab" onclick="filterByStatus('1', this)">å¤„ç†ä¸­</button>
                <button class="filter-tab" onclick="filterByStatus('2', this)">å·²å®Œæˆ</button>
                <button class="filter-tab" onclick="filterByStatus('3', this)">å·²å…³é—­</button>
            </div>
        </div>

        <!-- æ›´æ–°æç°åˆ—è¡¨ç»“æ„ -->
        <div class="withdraw-list">
            <div class="no-data" v-if="withdrawLogs.length === 0">
                æš‚æ— è®°å½•
            </div>
            <!-- æç°è®°å½•1 - æ”¯ä»˜å®/å¾®ä¿¡ -->
            <div class="withdraw-item" data-status="pending" v-for="item in withdrawLogs">
                <div class="withdraw-item-body">
                    <div class="withdraw-amount">
                        <span class="amount-label">æç°é‡‘é¢</span>
                        <span class="amount-value">Â¥{{item.amount}}</span>
                        <span class="withdraw-status pending">{{ getStatus(item.status) }}</span>
                    </div>
                    <div class="withdraw-info">
                        <div class="info-row">
                            <span class="info-label">è®¢å•å·</span>
                            <span class="info-value">
                                {{item.order_no}}
                                <button class="copy-btn" v-on:click="copyText(item.order_no)">å¤åˆ¶</button>
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æç°æ¸ é“</span>
                            <span class="info-value">{{ getChannel(item.pay_channel) }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ç”¨æˆ·å</span>
                            <span class="info-value">{{item.nickname}}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">æ”¶æ¬¾äºº</span>
                            <span class="info-value">{{item.name}}</span>
                        </div>

                        <div class="info-row" v-if="item.pay_info!=''&&(item.pay_channel=='CARD'||item.pay_channel=='USDT')">
                            <span class="info-label" v-if="item.pay_channel=='CARD'">å¡å·</span>
                            <span class="info-label" v-if="item.pay_channel=='USDT'">USDTåœ°å€</span>
                            <span class="info-value">
                                {{item.pay_info}}
                                <button class="copy-btn" v-on:click="copyText(item.pay_info)">å¤åˆ¶</button>
                            </span>
                        </div>

                    </div>
                    <div class="qrcode-section" v-if="item.pay_url!=''">
                        <div class="qrcode-title">æ”¶æ¬¾äºŒç»´ç </div>
                        <div class="qrcode-container">
                            <img :src="item.pay_url" style="width:200px;height:200px" onclick="viewImage(this.src)">
                            <div class="qrcode-actions">
                                <button class="qrcode-btn download" v-on:click="downloadImage(item.pay_url)">â¬‡ï¸ ä¸‹è½½</button>
                            </div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn reject" v-on:click="rejectWithdraw(item)" v-if="item.status==1">æ‹’ç»æç°</button>
                        <button class="action-btn approve" v-on:click="completeWithdraw(item)" v-if="item.status==1">å®Œæˆæç°</button>
                        <button class="action-btn approve" v-on:click="dealOrder(item)" v-if="item.status==0">å»å¤„ç†</button>
                    </div>
                    <div class="withdraw-time">ç”³è¯·æ—¶é—´: {{item.create_time}}</div>
                </div>
            </div>
        </div>

        <!-- å›¾ç‰‡æŸ¥çœ‹å¼¹çª— -->
        <div class="modal-overlay" id="imageModal" onclick="closeImageModal()">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-title">æ”¶æ¬¾äºŒç»´ç </div>
                <div style="text-align: center; margin-bottom: 15px;">
                    <img id="modalImage" src="/placeholder.svg" alt="æ”¶æ¬¾äºŒç»´ç " style="max-width: 100%; border-radius: 10px;">
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeImageModal()">å…³é—­</button>
                    <button class="modal-btn confirm" onclick="downViewImage()">ä¸‹è½½</button>
                </div>
            </div>
        </div>

        <!-- æ‹’ç»åŸå› å¼¹çª— -->
        <div class="modal-overlay active" v-if="rejectModal" style="display:none">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-title">æ‹’ç»æç°</div>
                <textarea class="modal-input" id="rejectReason" placeholder="è¯·è¾“å…¥æ‹’ç»åŸå› ..." style="height: 100px; resize: none;"></textarea>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" v-on:click="rejectModal=false">å–æ¶ˆ</button>
                    <button class="modal-btn confirm" onclick="confirmReject()">ç¡®è®¤æ‹’ç»</button>
                </div>
            </div>
        </div>

        <!-- Toastæç¤º -->
        <div class="toast" id="toast"></div>

        <!-- åº•éƒ¨å¯¼èˆª -->
        <nav class="bottom-nav">
            <a href="index.html" class="nav-item">
                <span class="nav-icon">ğŸ </span>
                <span>é¦–é¡µ</span>
            </a>
            <a href="admin-withdraw.html" class="nav-item active">
                <span class="nav-icon">ğŸ’°</span>
                <span>æç°ç®¡ç†</span>
            </a>
            <a href="profile.html" class="nav-item">
                <span class="nav-icon">ğŸ‘¤</span>
                <span>æˆ‘çš„</span>
            </a>
        </nav>
    </div>
    <script src="js/tinyVue.js"></script>
    <script src="js/common.js"></script>
    <script>
        const vm = tinyVue({
            el: "#app",
            data: {
                rejectModal: false,
                withdrawLogs: [],
                status: -1,
                rejectReason:"",
                rejectId: 0,

                // ===== åˆ†é¡µ =====
                pageIndex: 1,
                pageSize: 10,
                total: 0,
                totalPages: 1,

                // ===== è‡ªåŠ¨åŠ è½½æ§åˆ¶ =====
                isLoading: false,
                finished: false
            },

            methods: {
                getStatus(status) {
                    switch (status) {
                        case 0: return "å¾…å¤„ç†";
                        case 1: return "å¤„ç†ä¸­";
                        case 2: return "å·²å®Œæˆ";
                        case 3: return "å·²å…³é—­";
                    }
                    return "æœªçŸ¥çŠ¶æ€";
                },
                getChannel(channel) {
                    switch (channel) {
                        case 'WX': return "å¾®ä¿¡";
                        case 'ZFB': return "æ”¯ä»˜å®";
                        case "CARD": return "é“¶è¡Œå¡";
                        case "USDT": return "USDT";
                    }
                    return "æœªçŸ¥";
                },
                copyText(text) {
                    navigator.clipboard.writeText(text).then(() => {
                        showToast('å·²å¤åˆ¶: ' + text);
                    }).catch(() => {
                        showToast('å¤åˆ¶å¤±è´¥');
                    });
                },
            }
        });

        // åŠ è½½æ•°æ®
        async function loadData(append = false) {
            if (vm.isLoading) return;
            vm.isLoading = true;
            try {
                const p = await api("/api/finance/adminWithdrawLogs", "POST", {
                    status: vm.status,
                    pageIndex: vm.pageIndex,
                    pageSize: vm.pageSize
                });

                if (p) {
                    if (append) {
                        // è¿½åŠ åˆ°åˆ—è¡¨æœ«å°¾
                        vm.withdrawLogs = vm.withdrawLogs.concat(p.data || []);
                    } else {
                        // é¦–æ¬¡åŠ è½½ / åˆ‡æ¢çŠ¶æ€
                        vm.withdrawLogs = p.data || [];
                    }

                    vm.total = p.total || 0;
                    vm.totalPages = Math.max(1, Math.ceil(vm.total / vm.pageSize));

                    // å¦‚æœå·²ç»åˆ°æœ€åä¸€é¡µ
                    vm.finished = vm.pageIndex >= vm.totalPages;
                }

                vm.isLoading = false;
                vm.$forceUpdate();
            } finally {
                vm.isLoading = false;
            }
        }

        loadData(false);

        // ç­›é€‰çŠ¶æ€
        function filterByStatus(status, btn) {
            // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            btn.classList.add('active');

            // ç­›é€‰è®°å½•
            const items = document.querySelectorAll('.withdraw-item');
            items.forEach(item => {
                if (status === 'all' || item.dataset.status === status) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
            vm.status = status;
            vm.pageIndex = 1;
            vm.finished = false;
            vm.$forceUpdate();
            loadData(false);
        }


        // æŸ¥çœ‹å›¾ç‰‡
        function viewImage(src) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModal').classList.add('active');
        }

        function downViewImage() {
            
            const link = document.createElement('a');
            link.href = document.getElementById('modalImage').src;
            link.download = 'qrcode.png';
            link.click();
            showToast('å›¾ç‰‡ä¸‹è½½ä¸­...');
        }

        // å…³é—­å›¾ç‰‡å¼¹çª—
        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('active');
        }

        // ä¸‹è½½å›¾ç‰‡
        function downloadImage(imageSrc) {
            const link = document.createElement('a');
            link.href = imageSrc;
            link.download = 'qrcode.png';
            link.click();
            showToast('å›¾ç‰‡ä¸‹è½½ä¸­...');
        }

        async function dealOrder(item) {
            if (confirm('ç¡®è®¤ä¿®æ”¹è¯¥æç°[' + item.order_no+']ä¸ºå¤„ç†ä¸­ï¼Ÿ')) {
                const res = await api(`/api/finance/dealWithdraw/${item.id}`, "POST");
                if (!res) return;
                showToast('æç°æ­£åœ¨å¤„ç†ä¸­,è¯·å°½å¿«å®Œæˆä»˜æ¬¾');

                loadData(false);
            }
        }

        // å®Œæˆæç°
        async function completeWithdraw(item) {
            if (confirm('ç¡®è®¤å·²å®Œæˆä»˜æ¬¾å¹¶å¤„ç†æ­¤æç°ç”³è¯·ï¼Ÿ')) {
                const res = await api(`/api/finance/completeWithdraw/${item.id}`, "POST");
                if (!res) return;
                showToast('æç°å·²å®Œæˆ');

                loadData(false);
            }
        }

        // æ‹’ç»æç°
        async function rejectWithdraw(item) {
            vm.rejectId = item.id;
            vm.rejectModal = true;
        }


        // ç¡®è®¤æ‹’ç»
        async function confirmReject() {
            const reason = document.getElementById('rejectReason').value.trim();
            if (!reason) {
                showToast('è¯·è¾“å…¥æ‹’ç»åŸå› ');
                return;
            }
            const res = await api("/api/finance/closeWithdraw", "POST", {
                id: vm.rejectId,
                remark: reason
            });
            if (!res) return;
            showToast('æç°å·²æ‹’ç»');
            vm.rejectModal = false;
            loadData(false);
            
        }

        // æ˜¾ç¤ºæç¤º
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // æ»šåŠ¨ç›‘å¬ - è‡ªåŠ¨ä¸‹ä¸€é¡µ
        window.addEventListener('scroll', () => {
            if (vm.isLoading || vm.finished) return;

            const scrollTop = window.scrollY;
            const clientHeight = window.innerHeight;
            const scrollHeight = document.body.scrollHeight;

            // è·åº•éƒ¨ < 150 åƒç´ æ—¶åŠ è½½ä¸‹ä¸€é¡µ
            if (scrollTop + clientHeight >= scrollHeight - 150) {
                vm.pageIndex++;
                loadData(true); // è¿½åŠ åŠ è½½
            }
        });

    </script>
</body>
</html>
