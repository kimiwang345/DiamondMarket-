<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘å¸ƒå•†å“ - GameTrade</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container" id="app">

        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">ğŸ’</span>
                    <span class="logo-text">å‘å¸ƒé’»çŸ³å•†å“</span>
                </div>
                <button class="theme-toggle-btn" onclick="toggleTheme()">ğŸŒ“</button>
            </div>
        </header>

        <main class="main-content">
            <!-- æ–°å¢æœ€è¿‘ä¸‰å¤©å¹³å‡å•ä»·å±•ç¤ºåŒºåŸŸ -->
            <div class="price-stats-card">
                <div class="price-stats-header">
                    <span class="price-stats-title">è¿‘3æ—¥æˆäº¤å‡ä»·</span>
                    <span class="price-stats-badge">å®æ—¶æ•°æ®</span>
                </div>
                <div class="price-stats-body">
                    <div class="price-stat-item">
                        <div class="price-stat-value">Â¥{{unit_price}}</div>
                        <div class="price-stat-label">å¹³å‡å•ä»·/é’»</div>
                    </div>
                    <div class="price-stat-divider"></div>
                    <div class="price-stat-item">
                        <div class="price-stat-value">{{diamond_amount}}</div>
                        <div class="price-stat-label">æˆäº¤é’»çŸ³æ•°</div>
                    </div>
                    <div class="price-stat-divider"></div>
                    <div class="price-stat-item">
                        <div class="price-stat-value">{{total_count}}</div>
                        <div class="price-stat-label">æˆäº¤ç¬”æ•°</div>
                    </div>
                </div>
            </div>
            <!-- å‘å¸ƒç±»å‹é€‰æ‹© -->
            <div class="publish-type-selector">
                <button class="type-btn"
                        v-on:click="swichMode('sell')"
                        :class="{active: mode === 'sell'}">
                    å‡ºå”®é’»çŸ³
                </button>

                <button class="type-btn"
                        v-on:click="swichMode('recycle')"
                        :class="{active: mode === 'recycle'}">
                    å›æ”¶é’»çŸ³
                </button>
            </div>

            <!-- å‡ºå”®é’»çŸ³ -->
            <div class="form-container" v-if="mode === 'sell'">

                <div class="publish-form">

                    <!--<div class="form-group">
                        <label class="form-label">æ¸¸æˆç±»å‹</label>
                        <select class="form-input" v-model="sell.gameType" required>
                            <option value="">è¯·é€‰æ‹©æ¸¸æˆç±»å‹</option>
                            <option value="AGPoker">AGPoker</option>
                        </select>
                    </div>-->

                    <div class="form-group">
                        <label class="form-label">æ¸¸æˆè´¦å·</label>
                        <input type="text"
                               class="form-input"
                               v-model="sell.gameAccount"
                               placeholder="è¯·è¾“å…¥æ¸¸æˆè´¦å·"
                               required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¸¸æˆå¯†ç </label>
                        <input type="password"
                               class="form-input"
                               v-model="sell.gamePassword"
                               placeholder="è¯·è¾“å…¥æ¸¸æˆå¯†ç "
                               required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">é’»çŸ³æ•°é‡</label>
                        <input type="text"
                               class="form-input"
                               v-model="sell.amount"
                               placeholder="è¯·è¾“å…¥é’»çŸ³æ•°é‡"
                               required
                               oninput="this.value=this.value.replace(/[^0-9]/g,'')">
                        <span class="form-hint">æœ€å°‘å‘å¸ƒ100é’»çŸ³</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å•ä»· (å…ƒ/é’»)</label>
                        <input type="text"
                               class="form-input"
                               v-model="sell.unitPrice"
                               step="0.001"
                               min="0.001"
                               placeholder="è¯·è¾“å…¥å•ä»·"
                               required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ€»ä»·</label>
                        <div class="total-price">Â¥ {{ totalPrice }}</div>
                    </div>

                    <div class="form-actions">
                        <button class="btn-secondary" v-on:click="goBack">å–æ¶ˆ</button>
                        <button class="btn-primary" v-on:click="publishSell">ç«‹å³å‘å¸ƒ</button>
                    </div>
                </div>

                <div class="publish-tips">
                    <h3 class="tips-title">å‘å¸ƒé¡»çŸ¥</h3>
                    <ul class="tips-list">
                        <li>å‘å¸ƒå•†å“åï¼Œéœ€ç­‰å¾…ä¹°å®¶è´­ä¹°ï¼Œ<span style="color:red">ç¡®ä¿æœŸé—´æ¸¸æˆå†…é’»çŸ³æ•°é‡å……è¶³ï¼Œå¦åˆ™äº¤æ˜“å°†ä¼šå¤±è´¥ã€‚</span></li>
                        <li>äº¤æ˜“å®Œæˆåï¼Œæ¬¾é¡¹å°†è‡ªåŠ¨è½¬å…¥æ‚¨çš„å¹³å°ä½™é¢,å¹³å°ä¼šæ”¶å–5%çš„äº¤æ˜“æ‰‹ç»­è´¹</li>
                        <li>è¯·ç¡®ä¿å¡«å†™çš„ä¿¡æ¯å‡†ç¡®æ— è¯¯</li>
                    </ul>
                </div>
            </div>

            <!-- å›æ”¶é’»çŸ³ -->
            <div class="form-container" v-if="mode === 'recycle'">

                <div class="publish-form">

                    <div class="form-group">
                        <label class="form-label">æ¸¸æˆç±»å‹</label>
                        <select class="form-input" v-model="recyclingTasks.game_type" required>
                            <option value="">è¯·é€‰æ‹©æ¸¸æˆç±»å‹</option>
                            <option value="AGPoker">AGPoker</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¸¸æˆè´¦å·</label>
                        <input type="text"
                               class="form-input"
                               v-model="recyclingTasks.game_user"
                               placeholder="è¯·è¾“å…¥æ¸¸æˆè´¦å·"
                               required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¸¸æˆå¯†ç </label>
                        <input type="password"
                               class="form-input"
                               v-model="recyclingTasks.game_pass"
                               placeholder="è¯·è¾“å…¥æ¸¸æˆå¯†ç "
                               required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å•ä»·èŒƒå›´</label>
                        <div class="ratio-input-group">
                            <input type="text"
                                   class="form-input"
                                   v-model="recyclingTasks.min_unit_price"
                                   required>

                            <span class="ratio-separator">-</span>

                            <input type="text"
                                   class="form-input"
                                   v-model="recyclingTasks.max_unit_price"
                                   required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å›æ”¶æ•°é‡</label>
                        <input type="number"
                               class="form-input"
                               v-model="recyclingTasks.request_diamond"
                               placeholder="è¯·è¾“å…¥å›æ”¶æ•°é‡"
                               required>
                    </div>
                    <div class="form-group" v-if="recyclingTasks.status==0">
                        <label class="form-label">å›æ”¶ä¸­,å·²ç»å›æ”¶æ•°é‡</label>
                        <input type="number"
                               class="form-input"
                               v-model="recyclingTasks.fulfilled_diamond"
                               disabled>
                    </div>

                    <div class="form-actions">
                        <button class="btn-secondary" v-on:click="stopRecycle" v-if="recyclingTasks.status==0"><span style="color:red">å›æ”¶ä¸­,</span>ç‚¹å‡»åœæ­¢å›æ”¶</button>
                        <button class="btn-primary" v-on:click="publishRecycle" v-if="recyclingTasks.status==1||recyclingTasks.status==-1">å¼€å§‹å›æ”¶</button>
                    </div>
                </div>

                <div class="publish-tips">
                    <h3 class="tips-title">å›æ”¶è¯´æ˜</h3>
                    <ul class="tips-list">
                        <li>ç³»ç»Ÿå°†è‡ªåŠ¨è´­ä¹°ç¬¦åˆæ¡ä»¶çš„é’»çŸ³</li>
                        <li>æŒ‰ä»·æ ¼ä»ä½åˆ°é«˜è‡ªåŠ¨è´­ä¹°</li>
                        <li>ä½™é¢ä¸è¶³æ—¶ä¼šè‡ªåŠ¨åœæ­¢</li>
                    </ul>
                </div>
            </div>

        </main>

        <!-- åº•éƒ¨å¯¼èˆª -->
        <nav class="bottom-nav">
            <a href="index.html" class="nav-item">
                <span class="nav-icon">ğŸ </span>
                <span class="nav-label">é¦–é¡µ</span>
            </a>
            <a href="publish.html" class="nav-item active">
                <span class="nav-icon">â•</span>
                <span class="nav-label">å‘å¸ƒ</span>
            </a>
            <a href="profile.html" class="nav-item">
                <span class="nav-icon">ğŸ‘¤</span>
                <span class="nav-label">æˆ‘çš„</span>
            </a>
        </nav>

    </div>

    <script src="js/tinyVue.js"></script>
    <script src="js/common.js"></script>

    <!-- ============ å…¬å…±å·¥å…· + ä¸šåŠ¡é€»è¾‘ ============ -->
    <script>


        // åˆå§‹åŒ– tinyVueï¼ˆç¡®ä¿ DOM å·²å°±ç»ªï¼‰
        (function init() {
            function start() {
                window.vm = tinyVue({
                    el: "#app",
                    data: {
                        mode: "sell",
                        recyclingTasks: {
                            id: 0,
                            game_type: 'AGPoker',
                            game_user: '',
                            game_pass: '',
                            request_diamond: 0,
                            min_unit_price: 0,
                            max_unit_price: 0,
                            status: -1,
                        },
                        sell: {
                            gameType: "AGPoker",
                            gameAccount: "",
                            gamePassword: "",
                            amount: "",
                            unitPrice: ""
                        },
                        total_count: 0,
                        unit_price: 0,
                        diamond_amount: 0,
                    },
                    methods: {
                        goBack() {
                            location.href = "index.html";
                        },
                        swichMode(mode) {
                            this.mode = mode;
                        },
                        async publishSell() {
                            if (!this.sell.gameType ||
                                !this.sell.gameAccount ||
                                !this.sell.gamePassword) {
                                alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
                                return;
                            }

                            if (!this.sell.amount || parseInt(this.sell.amount) < 100) {
                                alert("é’»çŸ³æ•°é‡ä¸èƒ½å°‘äº100");
                                return;
                            }

                            if (!this.sell.unitPrice) {
                                alert("è¯·å¡«å†™å•ä»·");
                                return;
                            }

                            const res = await api("/api/diamond/publish", "POST", {
                                game_type: this.sell.gameType,
                                game_user: this.sell.gameAccount,
                                game_pass: this.sell.gamePassword,
                                diamond_amount: parseInt(this.sell.amount),
                                unit_price: parseFloat(this.sell.unitPrice)
                            });

                            if (!res) return;
                            location.href = "profile.html";
                        },

                        async publishRecycle() {
                            if (!this.recyclingTasks.game_type ||
                                !this.recyclingTasks.game_user ||
                                !this.recyclingTasks.game_pass) {
                                alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
                                return;
                            }

                            const minR = parseInt(this.recyclingTasks.min_unit_price) || 0;
                            const maxR = parseInt(this.recyclingTasks.max_unit_price) || 0;

                            if (minR > maxR) {
                                alert("æœ€ä½æ¯”ä¾‹ä¸èƒ½å¤§äºæœ€é«˜æ¯”ä¾‹");
                                return;
                            }

                            const res = await api("/api/diamond/create_recycling_tasks", "POST", this.recyclingTasks);

                            if (!res) return;
                            alert("å›æ”¶ä»»åŠ¡å·²å¯åŠ¨ï¼");
                            loadData();
                        },

                        async stopRecycle() {

                            const res = await api("/api/diamond/stop_recycling_tasks", "POST", this.recyclingTasks);
                            if (!res) return;
                            alert("å›æ”¶ä»»åŠ¡å·²åœæ­¢ï¼");
                            loadData();
                        },

                    }
                });

                // è®¡ç®—å±æ€§ totalPrice
                Object.defineProperty(vm, "totalPrice", {
                    get() {
                        const a = parseFloat(vm.sell.amount) || 0;
                        const p = parseFloat(vm.sell.unitPrice) || 0;
                        return (a * p).toFixed(2);
                    }
                });
            }

            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", start);
            } else {
                start();
            }
        })();

        async function loadData() {
            // åŠ è½½å›æ”¶ä»»åŠ¡,ä¸€ä¸ªç”¨æˆ·åªä¼šæœ‰ä¸€ä¸ªå›æ”¶ä»»åŠ¡*/
            const p = await api("/api/diamond/query_recycling_tasks");
            if (p.data) {
                vm.recyclingTasks = p.data;
            } else {
                vm.recyclingTasks = {
                    id: 0,
                    status: -1,
                }
            }
            vm.$forceUpdate();
        }
        async function loadData2() {
            const res = await api("/api/diamond/salelistRecent", "POST");
            if (!res) return;
            // åç«¯è¿”å› { code:0, data:[...] }
            vm.total_count = res.total_count || 0;
            vm.unit_price = res.unit_price || 0;
            vm.diamond_amount = res.diamond_amount || 0;

            // å¦‚æœ tinyVue æœ‰ $forceUpdateï¼Œå°±è°ƒç”¨ç¡®ä¿åˆ·æ–°
            vm.$forceUpdate();
        }
        loadData();
        loadData2();
    </script>

    <script>
        (function () {
            // åŸ‹ç‚¹æ¥å£
            const url = "/api/stat/page-view";
            const token = localStorage.getItem("token");
            // é¡µé¢æ•°æ®
            const data = {
                page: "å‘å¸ƒé¡µé¢",
                referrer: document.referrer,
                ua: navigator.userAgent,
                ts: Date.now()
            };

            fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    ...(token ? { "Authorization": "Bearer " + token } : {})
                },
                body: data ? JSON.stringify(data) : null
            });
        })();
    </script>
</body>
</html>
